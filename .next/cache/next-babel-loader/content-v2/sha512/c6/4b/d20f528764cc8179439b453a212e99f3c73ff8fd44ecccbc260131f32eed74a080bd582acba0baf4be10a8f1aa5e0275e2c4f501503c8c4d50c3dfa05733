{"ast":null,"code":"function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nimport React, { useEffect, useState } from 'react';\nimport { useQuery, useLazyQuery, useMutation } from '@apollo/react-hooks';\nimport { useDispatch } from 'react-redux';\nimport styled, { css } from 'styled-components';\nimport Row from '../../atomic-ui/components/Row';\nimport Column from '../../atomic-ui/components/Column';\nimport Member, { Content as MemberContent } from '../../atomic-ui/components/Member';\nimport Alert from '../../atomic-ui/components/Alert';\nimport Search from '../../atomic-ui/components/Search';\nimport Spinner from '../../atomic-ui/components/Spinner';\nimport Divider from '../../atomic-ui/components/Divider';\nimport { Loader } from '../Styled';\nimport { Wrap as WrapForm } from '../Form';\nimport MessengerChat from '../MessengerChat';\nimport { updateUser } from '../../store/actions/user';\nimport queries from '../../graphql/queries';\nexport const Wrap = styled(Row).withConfig({\n  displayName: \"Messenger__Wrap\",\n  componentId: \"sc-1hnkbvn-0\"\n})([\"height:100%;flex-grow:1;\", \"{width:100%;padding:0;}@media only screen and (max-width:568px){flex-direction:column;}\", \" \", \" \", \"\"], WrapForm, ({\n  appearance\n}) => appearance === 'default' && css([\"padding:var(--default-gap);background:var(--surface-background);border:var(--surface-border);border-radius:var(--surface-border-radius);box-shadow:var(--surface-shadow);\"]), ({\n  appearance\n}) => appearance === 'ghost' && css([\"padding:0;border:none;background:none;border-radius:0;box-shadow:none;\"]), ({\n  appearance\n}) => appearance === 'clear' && css([\"padding:0;border:none;background:none;border-radius:0;box-shadow:none;\"]));\nexport const ChatsSearch = styled(Search).withConfig({\n  displayName: \"Messenger__ChatsSearch\",\n  componentId: \"sc-1hnkbvn-1\"\n})([\"margin-bottom:10px;\"]);\nexport const Chats = styled(Column).withConfig({\n  displayName: \"Messenger__Chats\",\n  componentId: \"sc-1hnkbvn-2\"\n})([\"grid-gap:0;width:320px;@media only screen and (max-width:568px){width:100%;}\"]);\nexport const Chat = styled(Member).withConfig({\n  displayName: \"Messenger__Chat\",\n  componentId: \"sc-1hnkbvn-3\"\n})([\"margin:0;padding:10px 0;border-radius:var(--surface-border-radius);transition:all 150ms ease;\", \" \", \"\"], ({\n  noPaddingForPosition\n}) => noPaddingForPosition && css([\"\", \"{p{padding-right:0;}}\"], MemberContent), ({\n  active\n}) => active && css([\"background:var(--input-background);padding:10px;\"]));\nexport const getUnreadedMessages = (messages, sender) => (messages || []).reduce((acc, item) => {\n  var _item$user;\n\n  return acc + (item.type === 'UNREADED' && ((_item$user = item.user) === null || _item$user === void 0 ? void 0 : _item$user.email) !== sender ? 1 : 0);\n}, 0);\nexport const getLastMessage = (messages, sender) => {\n  var _message$user;\n\n  const list = messages || [];\n  const message = list[list.length - 1];\n  if (!message) return '';\n  return `${((_message$user = message.user) === null || _message$user === void 0 ? void 0 : _message$user.email) === sender ? 'Вы: ' : ''}${message.text}`;\n};\nexport const getExtendMessages = (messages, sender) => messages.map(message => ({ ...message,\n  side: sender === message.user.email ? 'owner' : 'observer'\n}));\nexport const ChatOne = ({\n  sender,\n  chat,\n  currentChat,\n  setLoading,\n  setCurrentChat,\n  getChat,\n  getTicket,\n  refetchChat,\n  refetchTicket\n}) => {\n  var _chat$chat, _chat$chat2, _chat$chat2$members$f, _chat$chat3, _chat$chat4, _chat$chat5, _chat$chat6, _chat$category, _chat$chat9;\n\n  return /*#__PURE__*/React.createElement(Chat, {\n    name: ((_chat$chat = chat.chat) === null || _chat$chat === void 0 ? void 0 : _chat$chat.members.filter(member => member.email !== (sender === null || sender === void 0 ? void 0 : sender.email))[0].name) || chat.title,\n    avatar: ((_chat$chat2 = chat.chat) === null || _chat$chat2 === void 0 ? void 0 : (_chat$chat2$members$f = _chat$chat2.members.filter(member => member.email !== (sender === null || sender === void 0 ? void 0 : sender.email))[0].avatar) === null || _chat$chat2$members$f === void 0 ? void 0 : _chat$chat2$members$f.path) || (chat.chat ? '/images/avatar-default.png' : null),\n    budge: ((_chat$chat3 = chat.chat) === null || _chat$chat3 === void 0 ? void 0 : _chat$chat3.messages) && getUnreadedMessages((_chat$chat4 = chat.chat) === null || _chat$chat4 === void 0 ? void 0 : _chat$chat4.messages, sender === null || sender === void 0 ? void 0 : sender.email) || null,\n    position: ((_chat$chat5 = chat.chat) === null || _chat$chat5 === void 0 ? void 0 : _chat$chat5.messages) && getLastMessage((_chat$chat6 = chat.chat) === null || _chat$chat6 === void 0 ? void 0 : _chat$chat6.messages, sender === null || sender === void 0 ? void 0 : sender.email) || ((_chat$category = chat.category) === null || _chat$category === void 0 ? void 0 : _chat$category.name) || null,\n    onClick: async () => {\n      var _chat$chat7;\n\n      setLoading(true);\n\n      if ((_chat$chat7 = chat.chat) !== null && _chat$chat7 !== void 0 && _chat$chat7.id) {\n        var _chat$chat8;\n\n        const variables = {\n          id: (_chat$chat8 = chat.chat) === null || _chat$chat8 === void 0 ? void 0 : _chat$chat8.id\n        };\n        if (refetchChat) await refetchChat(variables);else await getChat({\n          variables\n        });\n        setCurrentChat(chat.chat);\n      } else {\n        const variables = {\n          id: chat.id\n        };\n        if (refetchTicket) await refetchTicket(variables);else await getTicket({\n          variables\n        });\n        setCurrentChat(chat);\n      }\n\n      setLoading(false);\n    },\n    active: currentChat && currentChat.id === (((_chat$chat9 = chat.chat) === null || _chat$chat9 === void 0 ? void 0 : _chat$chat9.id) || chat.id),\n    noPaddingForPosition: !chat.chat\n  });\n};\nexport const Messenger = ({\n  appearance,\n  recipient,\n  sender,\n  onAttach,\n  onMemberLink,\n  ...props\n}) => {\n  const [currentChat, setCurrentChat] = useState(null);\n  const [filteredUserChats, setFilteredUserChats] = useState(null);\n  const [filteredTicketChats, setFilteredTicketChats] = useState(null);\n  const [ticketChats, setTicketChats] = useState([]);\n  const [userChats, setUserChats] = useState([]);\n  const [loading, setLoading] = useState(false);\n  const [search, setSearch] = useState('');\n  const dispatch = useDispatch();\n  const [getChat, {\n    data: chat,\n    loading: loadingChat,\n    error: errorChat,\n    refetch: refetchChat\n  }] = useLazyQuery(queries.GET_CHAT);\n  const [getTicket, {\n    data: ticket,\n    loading: loadingTicket,\n    error: errorTicket,\n    refetch: refetchTicket\n  }] = useLazyQuery(queries.GET_TICKET);\n  const {\n    data: dataUserChats,\n    loading: loadingUserChats,\n    error: errorUserChats,\n    refetch: getUserChats\n  } = useQuery(queries.GET_USER_CHATS);\n  const {\n    data: dataTicketChats,\n    loading: loadingTicketChats,\n    error: errorUserTickets,\n    refetch: getUserTickets\n  } = useQuery(queries.GET_USER_TICKETS);\n  const [sendMessage, {\n    data: dataSendMessage,\n    loading: loadingSendMessage,\n    error: errorSendMessage\n  }] = useMutation(queries.SEND_MESSAGE);\n  const [sendTicketMessage, {\n    data: dataUserSendMessage,\n    loading: loadingUserSendMessage,\n    error: errorUserSendMessage\n  }] = useMutation(queries.SEND_TICKET_MESSAGE);\n  const [readMessages, {\n    loading: loadingReadMessages\n  }] = useMutation(queries.READ_MESSAGES);\n  const [addUserChat, {\n    data: dataAddUserChat,\n    loading: loadingAddUserChat\n  }] = useMutation(queries.ADD_USER_CHAT);\n\n  const onSubmit = value => {\n    if (value) {\n      setFilteredUserChats(userChats.filter(userChat => {\n        var _userChat$chat;\n\n        return ((userChat === null || userChat === void 0 ? void 0 : (_userChat$chat = userChat.chat) === null || _userChat$chat === void 0 ? void 0 : _userChat$chat.members) || []).find(member => (member === null || member === void 0 ? void 0 : member.name.toUpperCase().includes(value.toUpperCase())) || (member === null || member === void 0 ? void 0 : member.email.toUpperCase().includes(value.toUpperCase())));\n      }));\n      setFilteredTicketChats(ticketChats.filter(ticketChat => {\n        var _ticketChat$category;\n\n        return (ticketChat === null || ticketChat === void 0 ? void 0 : ticketChat.title.toUpperCase().includes(value.toUpperCase())) || (ticketChat === null || ticketChat === void 0 ? void 0 : (_ticketChat$category = ticketChat.category) === null || _ticketChat$category === void 0 ? void 0 : _ticketChat$category.name.toUpperCase().includes(value.toUpperCase()));\n      }));\n    } else {\n      setFilteredUserChats(null);\n      setFilteredTicketChats(null);\n    }\n\n    setSearch(value);\n  };\n\n  useEffect(() => {\n    if (recipient) {\n      addUserChat({\n        variables: {\n          recipient: recipient === null || recipient === void 0 ? void 0 : recipient.email\n        }\n      });\n    }\n  }, [recipient, addUserChat]);\n  useEffect(() => {\n    if (!loadingAddUserChat && dataAddUserChat) {\n      getUserChats();\n      getUserTickets();\n    }\n  }, [loadingAddUserChat, dataAddUserChat, getUserChats, getUserTickets]);\n  useEffect(() => {\n    if (recipient && !currentChat && !loadingUserChats && dataUserChats !== null && dataUserChats !== void 0 && dataUserChats.getUserChats) {\n      var _dataUserChats$getUse;\n\n      const id = (_dataUserChats$getUse = dataUserChats.getUserChats.find(userChat => userChat.chat.members.find(member => member.email === (recipient === null || recipient === void 0 ? void 0 : recipient.email)))) === null || _dataUserChats$getUse === void 0 ? void 0 : _dataUserChats$getUse.chat.id;\n      if (id) getChat({\n        variables: {\n          id\n        }\n      });\n    }\n  }, [recipient, dataUserChats, loadingUserChats]);\n  useEffect(() => {\n    if (!loadingChat && chat !== null && chat !== void 0 && chat.getChat) {\n      setCurrentChat(chat.getChat);\n    }\n  }, [chat, loadingChat]);\n  useEffect(() => {\n    if (!loadingTicket && ticket !== null && ticket !== void 0 && ticket.getTicket) {\n      setCurrentChat(ticket.getTicket);\n    }\n  }, [ticket, loadingTicket]);\n  useEffect(() => {\n    if (!loadingSendMessage && dataSendMessage) {\n      setCurrentChat(prev => ({ ...prev,\n        messages: getExtendMessages(dataSendMessage.sendMessage, sender === null || sender === void 0 ? void 0 : sender.email)\n      }));\n    }\n  }, [sender, dataSendMessage, loadingSendMessage]);\n  useEffect(() => {\n    if (!loadingUserSendMessage && dataUserSendMessage) {\n      setCurrentChat(prev => ({ ...prev,\n        messages: getExtendMessages(dataUserSendMessage.sendTicketMessage, sender === null || sender === void 0 ? void 0 : sender.email)\n      }));\n    }\n  }, [sender, dataUserSendMessage, loadingUserSendMessage]);\n  useEffect(() => {\n    if (!loadingUserChats && dataUserChats !== null && dataUserChats !== void 0 && dataUserChats.getUserChats) {\n      setUserChats(dataUserChats.getUserChats);\n    }\n  }, [dataUserChats, loadingUserChats]);\n  useEffect(() => {\n    if (!loadingTicketChats && dataTicketChats !== null && dataTicketChats !== void 0 && dataTicketChats.getUserTickets) {\n      setTicketChats(dataTicketChats.getUserTickets);\n    }\n  }, [dataTicketChats, loadingTicketChats]);\n  useEffect(() => {\n    var _currentChat$messages;\n\n    const unreadedMessages = getUnreadedMessages((_currentChat$messages = currentChat === null || currentChat === void 0 ? void 0 : currentChat.messages) !== null && _currentChat$messages !== void 0 ? _currentChat$messages : [], sender);\n    const countOfNewMessages = sender.countOfNewMessages - unreadedMessages;\n\n    if (currentChat && unreadedMessages > 0) {\n      readMessages({\n        variables: {\n          id: currentChat.messages.filter(message => {\n            var _message$user2;\n\n            return ((_message$user2 = message.user) === null || _message$user2 === void 0 ? void 0 : _message$user2.email) !== (sender === null || sender === void 0 ? void 0 : sender.email);\n          }).map(message => message.id)\n        }\n      }).finally(() => dispatch(updateUser({\n        countOfNewMessages: countOfNewMessages > 0 || 0\n      })));\n    }\n  }, [dispatch, sender, currentChat, readMessages]);\n  return /*#__PURE__*/React.createElement(Wrap, _extends({}, props, {\n    key: loadingReadMessages,\n    appearance: appearance\n  }), /*#__PURE__*/React.createElement(Chats, null, /*#__PURE__*/React.createElement(ChatsSearch, {\n    appearance: 'ghost',\n    onSubmit: onSubmit\n  }), !loadingChat && !loadingTicket && !loadingUserChats && !loadingTicketChats && !loadingSendMessage && !loadingAddUserChat && !loadingUserSendMessage && (userChats.length > 0 || ticketChats.length > 0) ? /*#__PURE__*/React.createElement(React.Fragment, null, search && filteredUserChats && filteredTicketChats && filteredUserChats.length === 0 && filteredTicketChats.length === 0 && /*#__PURE__*/React.createElement(Alert, null, \"\\u041D\\u0438\\u0447\\u0435\\u0433\\u043E \\u043D\\u0435 \\u043D\\u0430\\u0439\\u0434\\u0435\\u043D\\u043E\"), (search && filteredUserChats || !search && userChats || []).map(userChat => {\n    var _userChat$chat2;\n\n    return /*#__PURE__*/React.createElement(ChatOne, {\n      key: (_userChat$chat2 = userChat.chat) === null || _userChat$chat2 === void 0 ? void 0 : _userChat$chat2.id,\n      chat: userChat,\n      sender: sender,\n      currentChat: currentChat,\n      setLoading: setLoading,\n      setCurrentChat: setCurrentChat,\n      getChat: getChat,\n      getTicket: getTicket,\n      refetchChat: refetchChat,\n      refetchTicket: refetchTicket\n    });\n  }), (filteredUserChats || userChats.length > 0 && !filteredUserChats) && /*#__PURE__*/React.createElement(Divider, null), (search && filteredTicketChats || !search && ticketChats || []).map(ticketChat => /*#__PURE__*/React.createElement(ChatOne, {\n    key: ticketChat.id,\n    chat: ticketChat,\n    sender: sender,\n    currentChat: currentChat,\n    setLoading: setLoading,\n    setCurrentChat: setCurrentChat,\n    getChat: getChat,\n    getTicket: getTicket,\n    refetchChat: refetchChat,\n    refetchTicket: refetchTicket\n  }))) : loadingChat || loadingTicket || loadingUserChats || loadingTicketChats || loadingSendMessage || loadingAddUserChat || loadingUserSendMessage ? /*#__PURE__*/React.createElement(Loader, null, /*#__PURE__*/React.createElement(Spinner, null)) : /*#__PURE__*/React.createElement(Alert, {\n    style: {\n      marginTop: 15\n    }\n  }, \"\\u0410\\u043A\\u0442\\u0438\\u0432\\u043D\\u044B\\u0435 \\u0447\\u0430\\u0442\\u044B \\u043E\\u0442\\u0441\\u0443\\u0442\\u0441\\u0442\\u0432\\u0443\\u044E\\u0442\")), /*#__PURE__*/React.createElement(MessengerChat, {\n    chat: currentChat && { ...currentChat,\n      messages: getExtendMessages(currentChat.messages, sender === null || sender === void 0 ? void 0 : sender.email)\n    },\n    appearance: 'ghost',\n    error: errorChat || errorTicket || errorUserChats || errorUserTickets || errorSendMessage || errorUserSendMessage,\n    loading: loading || loadingTicket || loadingChat || loadingUserChats || loadingTicketChats || loadingSendMessage || loadingAddUserChat || loadingUserSendMessage,\n    onLink: onMemberLink,\n    onAttach: onAttach,\n    onSubmit: value => {\n      if (currentChat.members) {\n        const candidate = currentChat.members.find(member => member.email !== (sender === null || sender === void 0 ? void 0 : sender.email));\n        sendMessage({\n          variables: {\n            sender: sender === null || sender === void 0 ? void 0 : sender.email,\n            recipient: (recipient === null || recipient === void 0 ? void 0 : recipient.email) || (candidate === null || candidate === void 0 ? void 0 : candidate.email),\n            text: value\n          }\n        });\n      } else {\n        var _currentChat$author;\n\n        sendTicketMessage({\n          variables: {\n            ticket: currentChat.id,\n            recipient: (_currentChat$author = currentChat.author) === null || _currentChat$author === void 0 ? void 0 : _currentChat$author.email,\n            text: value,\n            isClient: true\n          }\n        });\n      }\n    }\n  }));\n};\nMessenger.defaultProps = {\n  appearance: 'default'\n};\nexport default Messenger;","map":{"version":3,"sources":["/Users/malcore/Documents/workspace/freelance/atomic/atomic-frontend/components/Messenger/index.js"],"names":["React","useEffect","useState","useQuery","useLazyQuery","useMutation","useDispatch","styled","css","Row","Column","Member","Content","MemberContent","Alert","Search","Spinner","Divider","Loader","Wrap","WrapForm","MessengerChat","updateUser","queries","appearance","ChatsSearch","Chats","Chat","noPaddingForPosition","active","getUnreadedMessages","messages","sender","reduce","acc","item","type","user","email","getLastMessage","list","message","length","text","getExtendMessages","map","side","ChatOne","chat","currentChat","setLoading","setCurrentChat","getChat","getTicket","refetchChat","refetchTicket","members","filter","member","name","title","avatar","path","category","id","variables","Messenger","recipient","onAttach","onMemberLink","props","filteredUserChats","setFilteredUserChats","filteredTicketChats","setFilteredTicketChats","ticketChats","setTicketChats","userChats","setUserChats","loading","search","setSearch","dispatch","data","loadingChat","error","errorChat","refetch","GET_CHAT","ticket","loadingTicket","errorTicket","GET_TICKET","dataUserChats","loadingUserChats","errorUserChats","getUserChats","GET_USER_CHATS","dataTicketChats","loadingTicketChats","errorUserTickets","getUserTickets","GET_USER_TICKETS","sendMessage","dataSendMessage","loadingSendMessage","errorSendMessage","SEND_MESSAGE","sendTicketMessage","dataUserSendMessage","loadingUserSendMessage","errorUserSendMessage","SEND_TICKET_MESSAGE","readMessages","loadingReadMessages","READ_MESSAGES","addUserChat","dataAddUserChat","loadingAddUserChat","ADD_USER_CHAT","onSubmit","value","userChat","find","toUpperCase","includes","ticketChat","prev","unreadedMessages","countOfNewMessages","finally","marginTop","candidate","author","isClient","defaultProps"],"mappings":"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","sourcesContent":["import React, { useEffect, useState } from 'react'\nimport { useQuery, useLazyQuery, useMutation } from '@apollo/react-hooks'\nimport { useDispatch } from 'react-redux'\nimport styled, { css } from 'styled-components'\n\nimport Row from '../../atomic-ui/components/Row'\nimport Column from '../../atomic-ui/components/Column'\nimport Member, { Content as MemberContent } from '../../atomic-ui/components/Member'\nimport Alert from '../../atomic-ui/components/Alert'\nimport Search from '../../atomic-ui/components/Search'\nimport Spinner from '../../atomic-ui/components/Spinner'\nimport Divider from '../../atomic-ui/components/Divider'\n\nimport { Loader } from '../Styled'\nimport { Wrap as WrapForm } from '../Form'\nimport MessengerChat from '../MessengerChat'\nimport { updateUser } from '../../store/actions/user'\nimport queries from '../../graphql/queries'\n\nexport const Wrap = styled(Row)`\n  height: 100%;\n  flex-grow: 1;\n\n  ${WrapForm} {\n    width: 100%;\n    padding: 0;\n  }\n\n  @media only screen and (max-width: 568px) {\n    flex-direction: column;\n  }\n\n  ${({ appearance }) =>\n    appearance === 'default' &&\n    css`\n      padding: var(--default-gap);\n      background: var(--surface-background);\n      border: var(--surface-border);\n      border-radius: var(--surface-border-radius);\n      box-shadow: var(--surface-shadow);\n    `}\n\n  ${({ appearance }) =>\n    appearance === 'ghost' &&\n    css`\n      padding: 0;\n      border: none;\n      background: none;\n      border-radius: 0;\n      box-shadow: none;\n    `}\n\n  ${({ appearance }) =>\n    appearance === 'clear' &&\n    css`\n      padding: 0;\n      border: none;\n      background: none;\n      border-radius: 0;\n      box-shadow: none;\n    `}\n`\n\nexport const ChatsSearch = styled(Search)`\n  margin-bottom: 10px;\n`\n\nexport const Chats = styled(Column)`\n  grid-gap: 0;\n  width: 320px;\n\n  @media only screen and (max-width: 568px) {\n    width: 100%;\n  }\n`\n\nexport const Chat = styled(Member)`\n  margin: 0;\n  padding: 10px 0;\n  border-radius: var(--surface-border-radius);\n  transition: all 150ms ease;\n\n  ${({ noPaddingForPosition }) =>\n    noPaddingForPosition &&\n    css`\n      ${MemberContent} {\n        p {\n          padding-right: 0;\n        }\n      }\n    `}\n\n  ${({ active }) =>\n    active &&\n    css`\n      background: var(--input-background);\n      padding: 10px;\n    `}\n`\n\nexport const getUnreadedMessages = (messages, sender) =>\n  (messages || []).reduce(\n    (acc, item) => acc + (item.type === 'UNREADED' && item.user?.email !== sender ? 1 : 0),\n    0\n  )\n\nexport const getLastMessage = (messages, sender) => {\n  const list = messages || []\n  const message = list[list.length - 1]\n  if (!message) return ''\n  return `${message.user?.email === sender ? 'Вы: ' : ''}${message.text}`\n}\n\nexport const getExtendMessages = (messages, sender) =>\n  messages.map((message) => ({\n    ...message,\n    side: sender === message.user.email ? 'owner' : 'observer'\n  }))\n\nexport const ChatOne = ({\n  sender,\n  chat,\n  currentChat,\n  setLoading,\n  setCurrentChat,\n  getChat,\n  getTicket,\n  refetchChat,\n  refetchTicket\n}) => {\n  return (\n    <Chat\n      name={\n        chat.chat?.members.filter((member) => member.email !== sender?.email)[0].name || chat.title\n      }\n      avatar={\n        chat.chat?.members.filter((member) => member.email !== sender?.email)[0].avatar?.path ||\n        (chat.chat ? '/images/avatar-default.png' : null)\n      }\n      budge={\n        (chat.chat?.messages && getUnreadedMessages(chat.chat?.messages, sender?.email)) || null\n      }\n      position={\n        (chat.chat?.messages && getLastMessage(chat.chat?.messages, sender?.email)) ||\n        chat.category?.name ||\n        null\n      }\n      onClick={async () => {\n        setLoading(true)\n        if (chat.chat?.id) {\n          const variables = { id: chat.chat?.id }\n          if (refetchChat) await refetchChat(variables)\n          else await getChat({ variables })\n          setCurrentChat(chat.chat)\n        } else {\n          const variables = { id: chat.id }\n          if (refetchTicket) await refetchTicket(variables)\n          else await getTicket({ variables })\n          setCurrentChat(chat)\n        }\n        setLoading(false)\n      }}\n      active={currentChat && currentChat.id === (chat.chat?.id || chat.id)}\n      noPaddingForPosition={!chat.chat}\n    />\n  )\n}\n\nexport const Messenger = ({ appearance, recipient, sender, onAttach, onMemberLink, ...props }) => {\n  const [currentChat, setCurrentChat] = useState(null)\n  const [filteredUserChats, setFilteredUserChats] = useState(null)\n  const [filteredTicketChats, setFilteredTicketChats] = useState(null)\n  const [ticketChats, setTicketChats] = useState([])\n  const [userChats, setUserChats] = useState([])\n  const [loading, setLoading] = useState(false)\n  const [search, setSearch] = useState('')\n  const dispatch = useDispatch()\n\n  const [\n    getChat,\n    { data: chat, loading: loadingChat, error: errorChat, refetch: refetchChat }\n  ] = useLazyQuery(queries.GET_CHAT)\n\n  const [\n    getTicket,\n    { data: ticket, loading: loadingTicket, error: errorTicket, refetch: refetchTicket }\n  ] = useLazyQuery(queries.GET_TICKET)\n\n  const {\n    data: dataUserChats,\n    loading: loadingUserChats,\n    error: errorUserChats,\n    refetch: getUserChats\n  } = useQuery(queries.GET_USER_CHATS)\n\n  const {\n    data: dataTicketChats,\n    loading: loadingTicketChats,\n    error: errorUserTickets,\n    refetch: getUserTickets\n  } = useQuery(queries.GET_USER_TICKETS)\n\n  const [\n    sendMessage,\n    { data: dataSendMessage, loading: loadingSendMessage, error: errorSendMessage }\n  ] = useMutation(queries.SEND_MESSAGE)\n\n  const [\n    sendTicketMessage,\n    { data: dataUserSendMessage, loading: loadingUserSendMessage, error: errorUserSendMessage }\n  ] = useMutation(queries.SEND_TICKET_MESSAGE)\n\n  const [readMessages, { loading: loadingReadMessages }] = useMutation(queries.READ_MESSAGES)\n\n  const [addUserChat, { data: dataAddUserChat, loading: loadingAddUserChat }] = useMutation(\n    queries.ADD_USER_CHAT\n  )\n\n  const onSubmit = (value) => {\n    if (value) {\n      setFilteredUserChats(\n        userChats.filter((userChat) =>\n          (userChat?.chat?.members || []).find(\n            (member) =>\n              member?.name.toUpperCase().includes(value.toUpperCase()) ||\n              member?.email.toUpperCase().includes(value.toUpperCase())\n          )\n        )\n      )\n      setFilteredTicketChats(\n        ticketChats.filter(\n          (ticketChat) =>\n            ticketChat?.title.toUpperCase().includes(value.toUpperCase()) ||\n            ticketChat?.category?.name.toUpperCase().includes(value.toUpperCase())\n        )\n      )\n    } else {\n      setFilteredUserChats(null)\n      setFilteredTicketChats(null)\n    }\n    setSearch(value)\n  }\n\n  useEffect(() => {\n    if (recipient) {\n      addUserChat({\n        variables: {\n          recipient: recipient?.email\n        }\n      })\n    }\n  }, [recipient, addUserChat])\n\n  useEffect(() => {\n    if (!loadingAddUserChat && dataAddUserChat) {\n      getUserChats()\n      getUserTickets()\n    }\n  }, [loadingAddUserChat, dataAddUserChat, getUserChats, getUserTickets])\n\n  useEffect(() => {\n    if (recipient && !currentChat && !loadingUserChats && dataUserChats?.getUserChats) {\n      const id = dataUserChats.getUserChats.find((userChat) =>\n        userChat.chat.members.find((member) => member.email === recipient?.email)\n      )?.chat.id\n\n      if (id) getChat({ variables: { id } })\n    }\n  }, [recipient, dataUserChats, loadingUserChats])\n\n  useEffect(() => {\n    if (!loadingChat && chat?.getChat) {\n      setCurrentChat(chat.getChat)\n    }\n  }, [chat, loadingChat])\n\n  useEffect(() => {\n    if (!loadingTicket && ticket?.getTicket) {\n      setCurrentChat(ticket.getTicket)\n    }\n  }, [ticket, loadingTicket])\n\n  useEffect(() => {\n    if (!loadingSendMessage && dataSendMessage) {\n      setCurrentChat((prev) => ({\n        ...prev,\n        messages: getExtendMessages(dataSendMessage.sendMessage, sender?.email)\n      }))\n    }\n  }, [sender, dataSendMessage, loadingSendMessage])\n\n  useEffect(() => {\n    if (!loadingUserSendMessage && dataUserSendMessage) {\n      setCurrentChat((prev) => ({\n        ...prev,\n        messages: getExtendMessages(dataUserSendMessage.sendTicketMessage, sender?.email)\n      }))\n    }\n  }, [sender, dataUserSendMessage, loadingUserSendMessage])\n\n  useEffect(() => {\n    if (!loadingUserChats && dataUserChats?.getUserChats) {\n      setUserChats(dataUserChats.getUserChats)\n    }\n  }, [dataUserChats, loadingUserChats])\n\n  useEffect(() => {\n    if (!loadingTicketChats && dataTicketChats?.getUserTickets) {\n      setTicketChats(dataTicketChats.getUserTickets)\n    }\n  }, [dataTicketChats, loadingTicketChats])\n\n  useEffect(() => {\n    const unreadedMessages = getUnreadedMessages(currentChat?.messages ?? [], sender)\n    const countOfNewMessages = sender.countOfNewMessages - unreadedMessages\n\n    if (currentChat && unreadedMessages > 0) {\n      readMessages({\n        variables: {\n          id: currentChat.messages\n            .filter((message) => message.user?.email !== sender?.email)\n            .map((message) => message.id)\n        }\n      }).finally(() => dispatch(updateUser({ countOfNewMessages: countOfNewMessages > 0 || 0 })))\n    }\n  }, [dispatch, sender, currentChat, readMessages])\n\n  return (\n    <Wrap {...props} key={loadingReadMessages} appearance={appearance}>\n      <Chats>\n        <ChatsSearch appearance={'ghost'} onSubmit={onSubmit} />\n\n        {!loadingChat &&\n        !loadingTicket &&\n        !loadingUserChats &&\n        !loadingTicketChats &&\n        !loadingSendMessage &&\n        !loadingAddUserChat &&\n        !loadingUserSendMessage &&\n        (userChats.length > 0 || ticketChats.length > 0) ? (\n          <React.Fragment>\n            {search &&\n              filteredUserChats &&\n              filteredTicketChats &&\n              filteredUserChats.length === 0 &&\n              filteredTicketChats.length === 0 && <Alert>Ничего не найдено</Alert>}\n\n            {((search && filteredUserChats) || (!search && userChats) || []).map((userChat) => (\n              <ChatOne\n                key={userChat.chat?.id}\n                chat={userChat}\n                sender={sender}\n                currentChat={currentChat}\n                setLoading={setLoading}\n                setCurrentChat={setCurrentChat}\n                getChat={getChat}\n                getTicket={getTicket}\n                refetchChat={refetchChat}\n                refetchTicket={refetchTicket}\n              />\n            ))}\n\n            {(filteredUserChats || (userChats.length > 0 && !filteredUserChats)) && <Divider />}\n\n            {((search && filteredTicketChats) || (!search && ticketChats) || []).map(\n              (ticketChat) => (\n                <ChatOne\n                  key={ticketChat.id}\n                  chat={ticketChat}\n                  sender={sender}\n                  currentChat={currentChat}\n                  setLoading={setLoading}\n                  setCurrentChat={setCurrentChat}\n                  getChat={getChat}\n                  getTicket={getTicket}\n                  refetchChat={refetchChat}\n                  refetchTicket={refetchTicket}\n                />\n              )\n            )}\n          </React.Fragment>\n        ) : loadingChat ||\n          loadingTicket ||\n          loadingUserChats ||\n          loadingTicketChats ||\n          loadingSendMessage ||\n          loadingAddUserChat ||\n          loadingUserSendMessage ? (\n          <Loader>\n            <Spinner />\n          </Loader>\n        ) : (\n          <Alert style={{ marginTop: 15 }}>Активные чаты отсутствуют</Alert>\n        )}\n      </Chats>\n      <MessengerChat\n        chat={\n          currentChat && {\n            ...currentChat,\n            messages: getExtendMessages(currentChat.messages, sender?.email)\n          }\n        }\n        appearance={'ghost'}\n        error={\n          errorChat ||\n          errorTicket ||\n          errorUserChats ||\n          errorUserTickets ||\n          errorSendMessage ||\n          errorUserSendMessage\n        }\n        loading={\n          loading ||\n          loadingTicket ||\n          loadingChat ||\n          loadingUserChats ||\n          loadingTicketChats ||\n          loadingSendMessage ||\n          loadingAddUserChat ||\n          loadingUserSendMessage\n        }\n        onLink={onMemberLink}\n        onAttach={onAttach}\n        onSubmit={(value) => {\n          if (currentChat.members) {\n            const candidate = currentChat.members.find((member) => member.email !== sender?.email)\n            sendMessage({\n              variables: {\n                sender: sender?.email,\n                recipient: recipient?.email || candidate?.email,\n                text: value\n              }\n            })\n          } else {\n            sendTicketMessage({\n              variables: {\n                ticket: currentChat.id,\n                recipient: currentChat.author?.email,\n                text: value,\n                isClient: true\n              }\n            })\n          }\n        }}\n      />\n    </Wrap>\n  )\n}\n\nMessenger.defaultProps = {\n  appearance: 'default'\n}\n\nexport default Messenger\n"]},"metadata":{},"sourceType":"module"}