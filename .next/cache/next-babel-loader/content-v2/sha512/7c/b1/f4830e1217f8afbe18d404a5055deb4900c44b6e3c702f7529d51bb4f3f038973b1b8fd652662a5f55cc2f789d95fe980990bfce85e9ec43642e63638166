{"ast":null,"code":"function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nimport React, { useEffect, useState } from 'react';\nimport styled, { css } from 'styled-components';\nimport { useQuery, useLazyQuery, useMutation } from '@apollo/react-hooks';\nimport Row from '../../atomic-ui/components/Row';\nimport Column from '../../atomic-ui/components/Column';\nimport Member from '../../atomic-ui/components/Member';\nimport Alert from '../../atomic-ui/components/Alert';\nimport Search from '../../atomic-ui/components/Search';\nimport Spinner from '../../atomic-ui/components/Spinner';\nimport { Wrap as WrapForm } from '../Form';\nimport ChatForm from '../FormChat';\nimport { Loader } from '../Styled';\nimport queries from '../../graphql/queries';\nexport const Wrap = styled(Row).withConfig({\n  displayName: \"Messenger__Wrap\",\n  componentId: \"sc-1hnkbvn-0\"\n})([\"height:100%;flex-grow:1;\", \"{width:100%;padding:0;}@media only screen and (max-width:568px){flex-direction:column;}\", \" \", \" \", \"\"], WrapForm, ({\n  appearance\n}) => appearance === 'default' && css([\"padding:var(--default-gap);background:var(--surface-background);border:var(--surface-border);border-radius:var(--surface-border-radius);box-shadow:var(--surface-shadow);\"]), ({\n  appearance\n}) => appearance === 'ghost' && css([\"padding:0;border:none;background:none;border-radius:0;box-shadow:none;\"]), ({\n  appearance\n}) => appearance === 'clear' && css([\"padding:0;border:none;background:none;border-radius:0;box-shadow:none;\"]));\nexport const ChatsSearch = styled(Search).withConfig({\n  displayName: \"Messenger__ChatsSearch\",\n  componentId: \"sc-1hnkbvn-1\"\n})([\"margin-bottom:10px;\"]);\nexport const Chats = styled(Column).withConfig({\n  displayName: \"Messenger__Chats\",\n  componentId: \"sc-1hnkbvn-2\"\n})([\"grid-gap:0;width:320px;@media only screen and (max-width:568px){width:100%;}\"]);\nexport const Chat = styled(Member).withConfig({\n  displayName: \"Messenger__Chat\",\n  componentId: \"sc-1hnkbvn-3\"\n})([\"margin:0;padding:10px 0;border-radius:var(--surface-border-radius);transition:all 150ms ease;\", \"\"], ({\n  active\n}) => active && css([\"background:var(--input-background);padding:10px;\"]));\nexport const getUnreadedMessages = (messages, sender) => (messages || []).reduce((acc, item) => acc + (item.type === 'UNREADED' && item.user.name !== sender.name ? 1 : 0), 0);\nexport const Messenger = ({\n  appearance,\n  recipient,\n  sender,\n  onSubmit,\n  onMemberLink,\n  ...props\n}) => {\n  const [currentChat, setCurrentChat] = useState(null);\n  const [loading, setLoading] = useState(false);\n  const [chats, setChats] = useState([]);\n  const [getChat, {\n    data: chat,\n    loading: loadingChat,\n    refetch: refetchChat\n  }] = useLazyQuery(queries.GET_CHAT);\n  const [getTicket, {\n    data: ticket,\n    loading: loadingTicket,\n    refetch: refetchTicket\n  }] = useLazyQuery(queries.GET_CHAT);\n  const {\n    data: userChats,\n    loading: loadingUserChats,\n    refetch: getUserChats\n  } = useQuery(queries.GET_USER_CHATS);\n  const {\n    data: userTickets,\n    loading: loadingUserTickets,\n    refetch: getUserTickets\n  } = useQuery(queries.GET_USER_TICKETS);\n  const [addUserChat] = useMutation(queries.ADD_USER_CHAT);\n  useEffect(() => {\n    if (recipient) {\n      addUserChat({\n        variables: {\n          recipient: recipient.email\n        }\n      }).then(() => {\n        getUserChats().then();\n        getUserTickets().then();\n      });\n    }\n  }, [recipient, addUserChat]);\n  useEffect(() => {\n    if (recipient && !currentChat && !loadingUserChats && userChats && userChats.getUserChats) {\n      var _userChats$getUserCha;\n\n      getChat({\n        variables: {\n          id: (_userChats$getUserCha = userChats.getUserChats.find(userChat => userChat.chat.members.find(member => member.name === recipient.name))) === null || _userChats$getUserCha === void 0 ? void 0 : _userChats$getUserCha.chat.id\n        }\n      });\n    }\n  }, [recipient, userChats, loadingUserChats]);\n  useEffect(() => {\n    if (!loadingChat && chat && chat.getChat) {\n      setCurrentChat(chat.getChat);\n    }\n  }, [chat, loadingChat]);\n  useEffect(() => {\n    if (!loadingTicket && ticket && ticket.getTicket) {\n      setCurrentChat(ticket.getTicket);\n    }\n  }, [ticket, loadingTicket]);\n  useEffect(() => {\n    if (!loadingUserChats && userChats.getUserChats) {\n      setChats(prev => [...prev, ...userChats.getUserChats]);\n    }\n  }, [userChats, loadingUserChats]);\n  useEffect(() => {\n    if (!loadingUserTickets && userTickets.getUserTickets) {\n      setChats(prev => [...prev, ...userTickets.getUserTickets]);\n    }\n  }, [userTickets, loadingUserTickets]);\n  return /*#__PURE__*/React.createElement(Wrap, _extends({}, props, {\n    appearance: appearance\n  }), /*#__PURE__*/React.createElement(Chats, null, /*#__PURE__*/React.createElement(ChatsSearch, {\n    appearance: 'ghost'\n  }), loadingUserChats && !userChats && /*#__PURE__*/React.createElement(Spinner, null), chats.length > 0 ? chats.map(chat => {\n    var _chat$chat, _chat$chat2, _chat$counsellor, _chat$chat3, _chat$chat3$members$f, _chat$counsellor2, _chat$counsellor2$ava, _chat$chat4, _chat$chat4$messages, _chat$chat5, _chat$chat5$messages, _chat$chat6, _chat$chat7, _chat$chat7$messages, _chat$messages, _chat$chat9;\n\n    return /*#__PURE__*/React.createElement(Chat, {\n      key: ((_chat$chat = chat.chat) === null || _chat$chat === void 0 ? void 0 : _chat$chat.id) || chat.id,\n      name: ((_chat$chat2 = chat.chat) === null || _chat$chat2 === void 0 ? void 0 : _chat$chat2.members.filter(member => member.name !== sender.name)[0].name) || ((_chat$counsellor = chat.counsellor) === null || _chat$counsellor === void 0 ? void 0 : _chat$counsellor.name),\n      avatar: ((_chat$chat3 = chat.chat) === null || _chat$chat3 === void 0 ? void 0 : (_chat$chat3$members$f = _chat$chat3.members.filter(member => member.name !== sender.name)[0].avatar) === null || _chat$chat3$members$f === void 0 ? void 0 : _chat$chat3$members$f.path) || ((_chat$counsellor2 = chat.counsellor) === null || _chat$counsellor2 === void 0 ? void 0 : (_chat$counsellor2$ava = _chat$counsellor2.avatar) === null || _chat$counsellor2$ava === void 0 ? void 0 : _chat$counsellor2$ava.path) || '/images/avatar-default.png',\n      budge: ((_chat$chat4 = chat.chat) === null || _chat$chat4 === void 0 ? void 0 : (_chat$chat4$messages = _chat$chat4.messages[((_chat$chat5 = chat.chat) === null || _chat$chat5 === void 0 ? void 0 : (_chat$chat5$messages = _chat$chat5.messages) === null || _chat$chat5$messages === void 0 ? void 0 : _chat$chat5$messages.length) - 1]) === null || _chat$chat4$messages === void 0 ? void 0 : _chat$chat4$messages.user.name) !== sender.name && getUnreadedMessages((_chat$chat6 = chat.chat) === null || _chat$chat6 === void 0 ? void 0 : _chat$chat6.messages, sender) || getUnreadedMessages(chat.messages, sender) || null,\n      position: ((_chat$chat7 = chat.chat) === null || _chat$chat7 === void 0 ? void 0 : (_chat$chat7$messages = _chat$chat7.messages[chat.chat.messages.length - 1]) === null || _chat$chat7$messages === void 0 ? void 0 : _chat$chat7$messages.text) || ((_chat$messages = chat.messages[chat.messages.length - 1]) === null || _chat$messages === void 0 ? void 0 : _chat$messages.text) || null,\n      onClick: async () => {\n        var _chat$chat8;\n\n        setLoading(true);\n        await (chat.chat ? refetchChat || getChat : refetchTicket || getTicket)({\n          id: (_chat$chat8 = chat.chat) === null || _chat$chat8 === void 0 ? void 0 : _chat$chat8.id\n        });\n        setCurrentChat(chat === null || chat === void 0 ? void 0 : chat.chat);\n        setLoading(false);\n      },\n      active: currentChat && currentChat.id === ((_chat$chat9 = chat.chat) === null || _chat$chat9 === void 0 ? void 0 : _chat$chat9.id)\n    });\n  }) : loadingUserChats || loadingUserTickets ? /*#__PURE__*/React.createElement(Loader, null, /*#__PURE__*/React.createElement(Spinner, null)) : /*#__PURE__*/React.createElement(Alert, {\n    style: {\n      marginTop: 15\n    }\n  }, \"\\u0410\\u043A\\u0442\\u0438\\u0432\\u043D\\u044B\\u0435 \\u0447\\u0430\\u0442\\u044B \\u043E\\u0442\\u0441\\u0443\\u0442\\u0441\\u0442\\u0432\\u0443\\u044E\\u0442\")), /*#__PURE__*/React.createElement(ChatForm, {\n    mutation: queries.SEND_MESSAGE,\n    messages: currentChat && currentChat.messages.map(message => ({ ...message,\n      side: sender.name === message.user.name ? 'owner' : 'observer'\n    })),\n    appearance: 'ghost',\n    loading: loading || loadingChat || loadingUserChats,\n    onLink: onMemberLink,\n    onSubmit: async (form, action) => {\n      await onSubmit(form, action, currentChat.members.find(member => sender.name !== member.name));\n      await refetchChat({\n        id: currentChat.id\n      });\n    }\n  }));\n};\nMessenger.defaultProps = {\n  appearance: 'default'\n};\nexport default Messenger;","map":{"version":3,"sources":["C:/Users/dan82/Documents/workspace/FREELANCE/atomic/atomic-frontend/components/Messenger/index.js"],"names":["React","useEffect","useState","styled","css","useQuery","useLazyQuery","useMutation","Row","Column","Member","Alert","Search","Spinner","Wrap","WrapForm","ChatForm","Loader","queries","appearance","ChatsSearch","Chats","Chat","active","getUnreadedMessages","messages","sender","reduce","acc","item","type","user","name","Messenger","recipient","onSubmit","onMemberLink","props","currentChat","setCurrentChat","loading","setLoading","chats","setChats","getChat","data","chat","loadingChat","refetch","refetchChat","GET_CHAT","getTicket","ticket","loadingTicket","refetchTicket","userChats","loadingUserChats","getUserChats","GET_USER_CHATS","userTickets","loadingUserTickets","getUserTickets","GET_USER_TICKETS","addUserChat","ADD_USER_CHAT","variables","email","then","id","find","userChat","members","member","prev","length","map","filter","counsellor","avatar","path","text","marginTop","SEND_MESSAGE","message","side","form","action","defaultProps"],"mappings":"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","sourcesContent":["import React, { useEffect, useState } from 'react'\nimport styled, { css } from 'styled-components'\nimport { useQuery, useLazyQuery, useMutation } from '@apollo/react-hooks'\n\nimport Row from '../../atomic-ui/components/Row'\nimport Column from '../../atomic-ui/components/Column'\nimport Member from '../../atomic-ui/components/Member'\nimport Alert from '../../atomic-ui/components/Alert'\nimport Search from '../../atomic-ui/components/Search'\nimport Spinner from '../../atomic-ui/components/Spinner'\n\nimport { Wrap as WrapForm } from '../Form'\nimport ChatForm from '../FormChat'\nimport { Loader } from '../Styled'\nimport queries from '../../graphql/queries'\n\nexport const Wrap = styled(Row)`\n  height: 100%;\n  flex-grow: 1;\n\n  ${WrapForm} {\n    width: 100%;\n    padding: 0;\n  }\n\n  @media only screen and (max-width: 568px) {\n    flex-direction: column;\n  }\n\n  ${({ appearance }) =>\n    appearance === 'default' &&\n    css`\n      padding: var(--default-gap);\n      background: var(--surface-background);\n      border: var(--surface-border);\n      border-radius: var(--surface-border-radius);\n      box-shadow: var(--surface-shadow);\n    `}\n\n  ${({ appearance }) =>\n    appearance === 'ghost' &&\n    css`\n      padding: 0;\n      border: none;\n      background: none;\n      border-radius: 0;\n      box-shadow: none;\n    `}\n\n  ${({ appearance }) =>\n    appearance === 'clear' &&\n    css`\n      padding: 0;\n      border: none;\n      background: none;\n      border-radius: 0;\n      box-shadow: none;\n    `}\n`\n\nexport const ChatsSearch = styled(Search)`\n  margin-bottom: 10px;\n`\n\nexport const Chats = styled(Column)`\n  grid-gap: 0;\n  width: 320px;\n\n  @media only screen and (max-width: 568px) {\n    width: 100%;\n  }\n`\n\nexport const Chat = styled(Member)`\n  margin: 0;\n  padding: 10px 0;\n  border-radius: var(--surface-border-radius);\n  transition: all 150ms ease;\n\n  ${({ active }) =>\n    active &&\n    css`\n      background: var(--input-background);\n      padding: 10px;\n    `}\n`\n\nexport const getUnreadedMessages = (messages, sender) =>\n  (messages || []).reduce(\n    (acc, item) => acc + (item.type === 'UNREADED' && item.user.name !== sender.name ? 1 : 0),\n    0\n  )\n\nexport const Messenger = ({ appearance, recipient, sender, onSubmit, onMemberLink, ...props }) => {\n  const [currentChat, setCurrentChat] = useState(null)\n  const [loading, setLoading] = useState(false)\n  const [chats, setChats] = useState([])\n\n  const [getChat, { data: chat, loading: loadingChat, refetch: refetchChat }] = useLazyQuery(\n    queries.GET_CHAT\n  )\n  const [\n    getTicket,\n    { data: ticket, loading: loadingTicket, refetch: refetchTicket }\n  ] = useLazyQuery(queries.GET_CHAT)\n\n  const { data: userChats, loading: loadingUserChats, refetch: getUserChats } = useQuery(\n    queries.GET_USER_CHATS\n  )\n\n  const { data: userTickets, loading: loadingUserTickets, refetch: getUserTickets } = useQuery(\n    queries.GET_USER_TICKETS\n  )\n\n  const [addUserChat] = useMutation(queries.ADD_USER_CHAT)\n\n  useEffect(() => {\n    if (recipient) {\n      addUserChat({\n        variables: { recipient: recipient.email }\n      }).then(() => {\n        getUserChats().then()\n        getUserTickets().then()\n      })\n    }\n  }, [recipient, addUserChat])\n\n  useEffect(() => {\n    if (recipient && !currentChat && !loadingUserChats && userChats && userChats.getUserChats) {\n      getChat({\n        variables: {\n          id: userChats.getUserChats.find((userChat) =>\n            userChat.chat.members.find((member) => member.name === recipient.name)\n          )?.chat.id\n        }\n      })\n    }\n  }, [recipient, userChats, loadingUserChats])\n\n  useEffect(() => {\n    if (!loadingChat && chat && chat.getChat) {\n      setCurrentChat(chat.getChat)\n    }\n  }, [chat, loadingChat])\n\n  useEffect(() => {\n    if (!loadingTicket && ticket && ticket.getTicket) {\n      setCurrentChat(ticket.getTicket)\n    }\n  }, [ticket, loadingTicket])\n\n  useEffect(() => {\n    if (!loadingUserChats && userChats.getUserChats) {\n      setChats((prev) => [...prev, ...userChats.getUserChats])\n    }\n  }, [userChats, loadingUserChats])\n\n  useEffect(() => {\n    if (!loadingUserTickets && userTickets.getUserTickets) {\n      setChats((prev) => [...prev, ...userTickets.getUserTickets])\n    }\n  }, [userTickets, loadingUserTickets])\n\n  return (\n    <Wrap {...props} appearance={appearance}>\n      <Chats>\n        <ChatsSearch appearance={'ghost'} />\n        {loadingUserChats && !userChats && <Spinner />}\n        {chats.length > 0 ? (\n          chats.map((chat) => (\n            <Chat\n              key={chat.chat?.id || chat.id}\n              name={\n                chat.chat?.members.filter((member) => member.name !== sender.name)[0].name ||\n                chat.counsellor?.name\n              }\n              avatar={\n                chat.chat?.members.filter((member) => member.name !== sender.name)[0].avatar\n                  ?.path ||\n                chat.counsellor?.avatar?.path ||\n                '/images/avatar-default.png'\n              }\n              budge={\n                (chat.chat?.messages[chat.chat?.messages?.length - 1]?.user.name !== sender.name &&\n                  getUnreadedMessages(chat.chat?.messages, sender)) ||\n                getUnreadedMessages(chat.messages, sender) ||\n                null\n              }\n              position={\n                chat.chat?.messages[chat.chat.messages.length - 1]?.text ||\n                chat.messages[chat.messages.length - 1]?.text ||\n                null\n              }\n              onClick={async () => {\n                setLoading(true)\n                await (chat.chat ? refetchChat || getChat : refetchTicket || getTicket)({\n                  id: chat.chat?.id\n                })\n                setCurrentChat(chat?.chat)\n                setLoading(false)\n              }}\n              active={currentChat && currentChat.id === chat.chat?.id}\n            />\n          ))\n        ) : loadingUserChats || loadingUserTickets ? (\n          <Loader>\n            <Spinner />\n          </Loader>\n        ) : (\n          <Alert style={{ marginTop: 15 }}>Активные чаты отсутствуют</Alert>\n        )}\n      </Chats>\n      <ChatForm\n        mutation={queries.SEND_MESSAGE}\n        messages={\n          currentChat &&\n          currentChat.messages.map((message) => ({\n            ...message,\n            side: sender.name === message.user.name ? 'owner' : 'observer'\n          }))\n        }\n        appearance={'ghost'}\n        loading={loading || loadingChat || loadingUserChats}\n        onLink={onMemberLink}\n        onSubmit={async (form, action) => {\n          await onSubmit(\n            form,\n            action,\n            currentChat.members.find((member) => sender.name !== member.name)\n          )\n          await refetchChat({ id: currentChat.id })\n        }}\n      />\n    </Wrap>\n  )\n}\n\nMessenger.defaultProps = {\n  appearance: 'default'\n}\n\nexport default Messenger\n"]},"metadata":{},"sourceType":"module"}