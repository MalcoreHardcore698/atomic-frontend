{"ast":null,"code":"var _s = $RefreshSig$();\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nimport React, { useEffect, useState } from 'react';\nimport styled, { css } from 'styled-components';\nimport { useQuery, useLazyQuery, useMutation } from '@apollo/react-hooks';\nimport Row from '../../atomic-ui/components/Row';\nimport Column from '../../atomic-ui/components/Column';\nimport Member from '../../atomic-ui/components/Member';\nimport Alert from '../../atomic-ui/components/Alert';\nimport Search from '../../atomic-ui/components/Search';\nimport Spinner from '../../atomic-ui/components/Spinner';\nimport { Loader } from '../Styled';\nimport { Wrap as WrapForm } from '../Form';\nimport MessengerChat from '../MessengerChat';\nimport queries from '../../graphql/queries';\nexport const Wrap = styled(Row).withConfig({\n  displayName: \"Messenger__Wrap\",\n  componentId: \"sc-1hnkbvn-0\"\n})([\"height:100%;flex-grow:1;\", \"{width:100%;padding:0;}@media only screen and (max-width:568px){flex-direction:column;}\", \" \", \" \", \"\"], WrapForm, ({\n  appearance\n}) => appearance === 'default' && css([\"padding:var(--default-gap);background:var(--surface-background);border:var(--surface-border);border-radius:var(--surface-border-radius);box-shadow:var(--surface-shadow);\"]), ({\n  appearance\n}) => appearance === 'ghost' && css([\"padding:0;border:none;background:none;border-radius:0;box-shadow:none;\"]), ({\n  appearance\n}) => appearance === 'clear' && css([\"padding:0;border:none;background:none;border-radius:0;box-shadow:none;\"]));\n_c = Wrap;\nexport const ChatsSearch = styled(Search).withConfig({\n  displayName: \"Messenger__ChatsSearch\",\n  componentId: \"sc-1hnkbvn-1\"\n})([\"margin-bottom:10px;\"]);\n_c2 = ChatsSearch;\nexport const Chats = styled(Column).withConfig({\n  displayName: \"Messenger__Chats\",\n  componentId: \"sc-1hnkbvn-2\"\n})([\"grid-gap:0;width:320px;@media only screen and (max-width:568px){width:100%;}\"]);\n_c3 = Chats;\nexport const Chat = styled(Member).withConfig({\n  displayName: \"Messenger__Chat\",\n  componentId: \"sc-1hnkbvn-3\"\n})([\"margin:0;padding:10px 0;border-radius:var(--surface-border-radius);transition:all 150ms ease;\", \"\"], ({\n  active\n}) => active && css([\"background:var(--input-background);padding:10px;\"]));\n_c4 = Chat;\nexport const fetchPolicy = {\n  fetchPolicy: 'no-cache'\n};\nexport const getUnreadedMessages = (messages, sender) => (messages || []).reduce((acc, item) => acc + (item.type === 'UNREADED' && item.user.email !== sender.email ? 1 : 0), 0);\nexport const getLastMessage = (messages, sender) => {\n  var _message$user;\n\n  const list = messages || [];\n  const message = list[list.length - 1];\n  return `${((_message$user = message.user) === null || _message$user === void 0 ? void 0 : _message$user.email) === sender.email ? 'Вы: ' : ''}${message.text}`;\n};\nexport const getExtendMessages = (messages, sender) => messages.map(message => ({ ...message,\n  side: sender.name === message.user.name ? 'owner' : 'observer'\n}));\nexport const Messenger = ({\n  appearance,\n  recipient,\n  sender,\n  onAttach,\n  onMemberLink,\n  ...props\n}) => {\n  _s();\n\n  const [currentChat, setCurrentChat] = useState(null);\n  const [loading, setLoading] = useState(false);\n  const [chats, setChats] = useState([]);\n  const [getChat, {\n    data: chat,\n    loading: loadingChat,\n    error: errorChat,\n    refetch: refetchChat\n  }] = useLazyQuery(queries.GET_CHAT);\n  const [getTicket, {\n    data: ticket,\n    loading: loadingTicket,\n    error: errorTicket,\n    refetch: refetchTicket\n  }] = useLazyQuery(queries.GET_TICKET);\n  const {\n    data: userChats,\n    loading: loadingUserChats,\n    error: errorUserChats,\n    refetch: getUserChats\n  } = useQuery(queries.GET_USER_CHATS);\n  const {\n    data: userTickets,\n    loading: loadingUserTickets,\n    error: errorUserTickets,\n    refetch: getUserTickets\n  } = useQuery(queries.GET_USER_TICKETS);\n  const [sendMessage, {\n    data: dataSendMessage,\n    loading: loadingSendMessage,\n    error: errorSendMessage\n  }] = useMutation(queries.SEND_MESSAGE);\n  const [sendTicketMessage, {\n    data: dataUserSendMessage,\n    loading: loadingUserSendMessage,\n    error: errorUserSendMessage\n  }] = useMutation(queries.SEND_TICKET_MESSAGE);\n  const [addUserChat] = useMutation(queries.ADD_USER_CHAT);\n  useEffect(() => {\n    if (recipient) {\n      addUserChat({\n        variables: {\n          recipient: recipient.email\n        },\n        fetchPolicy\n      }).then(() => {\n        getUserChats().then();\n        getUserTickets().then();\n      });\n    }\n  }, [recipient, addUserChat]);\n  useEffect(() => {\n    if (recipient && !currentChat && !loadingUserChats && userChats !== null && userChats !== void 0 && userChats.getUserChats) {\n      var _userChats$getUserCha;\n\n      getChat({\n        variables: {\n          id: (_userChats$getUserCha = userChats.getUserChats.find(userChat => userChat.chat.members.find(member => member.name === recipient.name))) === null || _userChats$getUserCha === void 0 ? void 0 : _userChats$getUserCha.chat.id\n        },\n        fetchPolicy\n      });\n    }\n  }, [recipient, userChats, loadingUserChats]);\n  useEffect(() => {\n    if (!loadingChat && chat !== null && chat !== void 0 && chat.getChat) {\n      setCurrentChat(chat.getChat);\n    }\n  }, [chat, loadingChat]);\n  useEffect(() => {\n    if (!loadingTicket && ticket !== null && ticket !== void 0 && ticket.getTicket) {\n      setCurrentChat(ticket.getTicket);\n    }\n  }, [ticket, loadingTicket]);\n  useEffect(() => {\n    if (!loadingSendMessage && dataSendMessage) {\n      setCurrentChat(prev => ({ ...prev,\n        messages: getExtendMessages(dataSendMessage.sendTicketMessage, sender)\n      }));\n    }\n  }, [sender, dataSendMessage, loadingSendMessage]);\n  useEffect(() => {\n    if (!loadingUserSendMessage && dataUserSendMessage) {\n      setCurrentChat(prev => ({ ...prev,\n        messages: getExtendMessages(dataUserSendMessage.sendTicketMessage, sender)\n      }));\n    }\n  }, [sender, dataUserSendMessage, loadingUserSendMessage]);\n  useEffect(() => {\n    if (!loadingUserChats && userChats !== null && userChats !== void 0 && userChats.getUserChats) {\n      setChats(prev => [...prev, ...userChats.getUserChats]);\n    }\n  }, [userChats, loadingUserChats]);\n  useEffect(() => {\n    if (!loadingUserTickets && userTickets !== null && userTickets !== void 0 && userTickets.getUserTickets) {\n      setChats(prev => [...prev, ...userTickets.getUserTickets]);\n    }\n  }, [userTickets, loadingUserTickets]);\n  return /*#__PURE__*/React.createElement(Wrap, _extends({}, props, {\n    appearance: appearance\n  }), /*#__PURE__*/React.createElement(Chats, null, /*#__PURE__*/React.createElement(ChatsSearch, {\n    appearance: 'ghost'\n  }), loadingUserChats && !userChats && /*#__PURE__*/React.createElement(Spinner, null), chats.length > 0 ? chats.map(chat => {\n    var _chat$chat, _chat$chat2, _chat$counsellor, _chat$chat3, _chat$chat3$members$f, _chat$counsellor2, _chat$counsellor2$ava, _chat$chat4, _chat$chat5, _chat$chat6, _chat$chat7, _chat$chat10;\n\n    return /*#__PURE__*/React.createElement(Chat, {\n      key: ((_chat$chat = chat.chat) === null || _chat$chat === void 0 ? void 0 : _chat$chat.id) || chat.id,\n      name: ((_chat$chat2 = chat.chat) === null || _chat$chat2 === void 0 ? void 0 : _chat$chat2.members.filter(member => member.name !== sender.name)[0].name) || ((_chat$counsellor = chat.counsellor) === null || _chat$counsellor === void 0 ? void 0 : _chat$counsellor.name),\n      avatar: ((_chat$chat3 = chat.chat) === null || _chat$chat3 === void 0 ? void 0 : (_chat$chat3$members$f = _chat$chat3.members.filter(member => member.name !== sender.name)[0].avatar) === null || _chat$chat3$members$f === void 0 ? void 0 : _chat$chat3$members$f.path) || ((_chat$counsellor2 = chat.counsellor) === null || _chat$counsellor2 === void 0 ? void 0 : (_chat$counsellor2$ava = _chat$counsellor2.avatar) === null || _chat$counsellor2$ava === void 0 ? void 0 : _chat$counsellor2$ava.path) || '/images/avatar-default.png',\n      budge: ((_chat$chat4 = chat.chat) === null || _chat$chat4 === void 0 ? void 0 : _chat$chat4.messages) && getUnreadedMessages((_chat$chat5 = chat.chat) === null || _chat$chat5 === void 0 ? void 0 : _chat$chat5.messages, sender) || chat.messages && getUnreadedMessages(chat.messages, sender) || null,\n      position: ((_chat$chat6 = chat.chat) === null || _chat$chat6 === void 0 ? void 0 : _chat$chat6.messages) && getLastMessage((_chat$chat7 = chat.chat) === null || _chat$chat7 === void 0 ? void 0 : _chat$chat7.messages, sender) || chat.messages && getLastMessage(chat.messages, sender) || null,\n      onClick: async () => {\n        var _chat$chat8;\n\n        setLoading(true);\n\n        if ((_chat$chat8 = chat.chat) !== null && _chat$chat8 !== void 0 && _chat$chat8.id) {\n          var _chat$chat9;\n\n          const variables = {\n            id: (_chat$chat9 = chat.chat) === null || _chat$chat9 === void 0 ? void 0 : _chat$chat9.id\n          };\n          if (refetchChat) await refetchChat(variables);else await getChat({\n            variables,\n            fetchPolicy\n          });\n          setCurrentChat(chat.chat);\n        } else {\n          const variables = {\n            id: chat.id\n          };\n          if (refetchTicket) await refetchTicket(variables);else await getTicket({\n            variables,\n            fetchPolicy\n          });\n          setCurrentChat(chat);\n        }\n\n        setLoading(false);\n      },\n      active: currentChat && currentChat.id === (((_chat$chat10 = chat.chat) === null || _chat$chat10 === void 0 ? void 0 : _chat$chat10.id) || chat.id)\n    });\n  }) : loadingUserChats || loadingUserTickets ? /*#__PURE__*/React.createElement(Loader, null, /*#__PURE__*/React.createElement(Spinner, null)) : /*#__PURE__*/React.createElement(Alert, {\n    style: {\n      marginTop: 15\n    }\n  }, \"\\u0410\\u043A\\u0442\\u0438\\u0432\\u043D\\u044B\\u0435 \\u0447\\u0430\\u0442\\u044B \\u043E\\u0442\\u0441\\u0443\\u0442\\u0441\\u0442\\u0432\\u0443\\u044E\\u0442\")), /*#__PURE__*/React.createElement(MessengerChat, {\n    chat: currentChat && { ...currentChat,\n      messages: currentChat.messages.map(message => ({ ...message,\n        side: sender.name === message.user.name ? 'owner' : 'observer'\n      }))\n    },\n    appearance: 'ghost',\n    error: errorChat || errorTicket || errorUserChats || errorUserTickets || errorSendMessage || errorUserSendMessage,\n    loading: loading || loadingTicket || loadingChat || loadingUserChats || loadingUserTickets || loadingSendMessage || loadingUserSendMessage,\n    onLink: onMemberLink,\n    onAttach: onAttach,\n    onSubmit: value => {\n      if (currentChat.chat) {\n        var _currentChat$chat$rec;\n\n        sendMessage({\n          variables: {\n            recipient: (_currentChat$chat$rec = currentChat.chat.recipient) === null || _currentChat$chat$rec === void 0 ? void 0 : _currentChat$chat$rec.email,\n            text: value\n          },\n          fetchPolicy\n        });\n      } else {\n        var _currentChat$author;\n\n        sendTicketMessage({\n          variables: {\n            ticket: currentChat.id,\n            recipient: (_currentChat$author = currentChat.author) === null || _currentChat$author === void 0 ? void 0 : _currentChat$author.email,\n            text: value,\n            isClient: true\n          },\n          fetchPolicy\n        });\n      }\n    }\n  }));\n};\n\n_s(Messenger, \"dQDM7fyY9lt2p9FJRrShCB0WXwE=\", false, function () {\n  return [useLazyQuery, useLazyQuery, useQuery, useQuery, useMutation, useMutation, useMutation];\n});\n\n_c5 = Messenger;\nMessenger.defaultProps = {\n  appearance: 'default'\n};\nexport default Messenger;\n\nvar _c, _c2, _c3, _c4, _c5;\n\n$RefreshReg$(_c, \"Wrap\");\n$RefreshReg$(_c2, \"ChatsSearch\");\n$RefreshReg$(_c3, \"Chats\");\n$RefreshReg$(_c4, \"Chat\");\n$RefreshReg$(_c5, \"Messenger\");","map":{"version":3,"sources":["C:/Users/dan82/Documents/workspace/FREELANCE/atomic/atomic-frontend/components/Messenger/index.js"],"names":["React","useEffect","useState","styled","css","useQuery","useLazyQuery","useMutation","Row","Column","Member","Alert","Search","Spinner","Loader","Wrap","WrapForm","MessengerChat","queries","appearance","ChatsSearch","Chats","Chat","active","fetchPolicy","getUnreadedMessages","messages","sender","reduce","acc","item","type","user","email","getLastMessage","list","message","length","text","getExtendMessages","map","side","name","Messenger","recipient","onAttach","onMemberLink","props","currentChat","setCurrentChat","loading","setLoading","chats","setChats","getChat","data","chat","loadingChat","error","errorChat","refetch","refetchChat","GET_CHAT","getTicket","ticket","loadingTicket","errorTicket","refetchTicket","GET_TICKET","userChats","loadingUserChats","errorUserChats","getUserChats","GET_USER_CHATS","userTickets","loadingUserTickets","errorUserTickets","getUserTickets","GET_USER_TICKETS","sendMessage","dataSendMessage","loadingSendMessage","errorSendMessage","SEND_MESSAGE","sendTicketMessage","dataUserSendMessage","loadingUserSendMessage","errorUserSendMessage","SEND_TICKET_MESSAGE","addUserChat","ADD_USER_CHAT","variables","then","id","find","userChat","members","member","prev","filter","counsellor","avatar","path","marginTop","value","author","isClient","defaultProps"],"mappings":"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","sourcesContent":["import React, { useEffect, useState } from 'react'\nimport styled, { css } from 'styled-components'\nimport { useQuery, useLazyQuery, useMutation } from '@apollo/react-hooks'\n\nimport Row from '../../atomic-ui/components/Row'\nimport Column from '../../atomic-ui/components/Column'\nimport Member from '../../atomic-ui/components/Member'\nimport Alert from '../../atomic-ui/components/Alert'\nimport Search from '../../atomic-ui/components/Search'\nimport Spinner from '../../atomic-ui/components/Spinner'\n\nimport { Loader } from '../Styled'\nimport { Wrap as WrapForm } from '../Form'\nimport MessengerChat from '../MessengerChat'\nimport queries from '../../graphql/queries'\n\nexport const Wrap = styled(Row)`\n  height: 100%;\n  flex-grow: 1;\n\n  ${WrapForm} {\n    width: 100%;\n    padding: 0;\n  }\n\n  @media only screen and (max-width: 568px) {\n    flex-direction: column;\n  }\n\n  ${({ appearance }) =>\n    appearance === 'default' &&\n    css`\n      padding: var(--default-gap);\n      background: var(--surface-background);\n      border: var(--surface-border);\n      border-radius: var(--surface-border-radius);\n      box-shadow: var(--surface-shadow);\n    `}\n\n  ${({ appearance }) =>\n    appearance === 'ghost' &&\n    css`\n      padding: 0;\n      border: none;\n      background: none;\n      border-radius: 0;\n      box-shadow: none;\n    `}\n\n  ${({ appearance }) =>\n    appearance === 'clear' &&\n    css`\n      padding: 0;\n      border: none;\n      background: none;\n      border-radius: 0;\n      box-shadow: none;\n    `}\n`\n\nexport const ChatsSearch = styled(Search)`\n  margin-bottom: 10px;\n`\n\nexport const Chats = styled(Column)`\n  grid-gap: 0;\n  width: 320px;\n\n  @media only screen and (max-width: 568px) {\n    width: 100%;\n  }\n`\n\nexport const Chat = styled(Member)`\n  margin: 0;\n  padding: 10px 0;\n  border-radius: var(--surface-border-radius);\n  transition: all 150ms ease;\n\n  ${({ active }) =>\n    active &&\n    css`\n      background: var(--input-background);\n      padding: 10px;\n    `}\n`\n\nexport const fetchPolicy = {\n  fetchPolicy: 'no-cache'\n}\n\nexport const getUnreadedMessages = (messages, sender) =>\n  (messages || []).reduce(\n    (acc, item) => acc + (item.type === 'UNREADED' && item.user.email !== sender.email ? 1 : 0),\n    0\n  )\n\nexport const getLastMessage = (messages, sender) => {\n  const list = messages || []\n  const message = list[list.length - 1]\n  return `${message.user?.email === sender.email ? 'Вы: ' : ''}${message.text}`\n}\n\nexport const getExtendMessages = (messages, sender) =>\n  messages.map((message) => ({\n    ...message,\n    side: sender.name === message.user.name ? 'owner' : 'observer'\n  }))\n\nexport const Messenger = ({ appearance, recipient, sender, onAttach, onMemberLink, ...props }) => {\n  const [currentChat, setCurrentChat] = useState(null)\n  const [loading, setLoading] = useState(false)\n  const [chats, setChats] = useState([])\n\n  const [\n    getChat,\n    { data: chat, loading: loadingChat, error: errorChat, refetch: refetchChat }\n  ] = useLazyQuery(queries.GET_CHAT)\n  const [\n    getTicket,\n    { data: ticket, loading: loadingTicket, error: errorTicket, refetch: refetchTicket }\n  ] = useLazyQuery(queries.GET_TICKET)\n\n  const {\n    data: userChats,\n    loading: loadingUserChats,\n    error: errorUserChats,\n    refetch: getUserChats\n  } = useQuery(queries.GET_USER_CHATS)\n\n  const {\n    data: userTickets,\n    loading: loadingUserTickets,\n    error: errorUserTickets,\n    refetch: getUserTickets\n  } = useQuery(queries.GET_USER_TICKETS)\n\n  const [\n    sendMessage,\n    { data: dataSendMessage, loading: loadingSendMessage, error: errorSendMessage }\n  ] = useMutation(queries.SEND_MESSAGE)\n  const [\n    sendTicketMessage,\n    { data: dataUserSendMessage, loading: loadingUserSendMessage, error: errorUserSendMessage }\n  ] = useMutation(queries.SEND_TICKET_MESSAGE)\n  const [addUserChat] = useMutation(queries.ADD_USER_CHAT)\n\n  useEffect(() => {\n    if (recipient) {\n      addUserChat({\n        variables: { recipient: recipient.email },\n        fetchPolicy\n      }).then(() => {\n        getUserChats().then()\n        getUserTickets().then()\n      })\n    }\n  }, [recipient, addUserChat])\n\n  useEffect(() => {\n    if (recipient && !currentChat && !loadingUserChats && userChats?.getUserChats) {\n      getChat({\n        variables: {\n          id: userChats.getUserChats.find((userChat) =>\n            userChat.chat.members.find((member) => member.name === recipient.name)\n          )?.chat.id\n        },\n        fetchPolicy\n      })\n    }\n  }, [recipient, userChats, loadingUserChats])\n\n  useEffect(() => {\n    if (!loadingChat && chat?.getChat) {\n      setCurrentChat(chat.getChat)\n    }\n  }, [chat, loadingChat])\n\n  useEffect(() => {\n    if (!loadingTicket && ticket?.getTicket) {\n      setCurrentChat(ticket.getTicket)\n    }\n  }, [ticket, loadingTicket])\n\n  useEffect(() => {\n    if (!loadingSendMessage && dataSendMessage) {\n      setCurrentChat((prev) => ({\n        ...prev,\n        messages: getExtendMessages(dataSendMessage.sendTicketMessage, sender)\n      }))\n    }\n  }, [sender, dataSendMessage, loadingSendMessage])\n\n  useEffect(() => {\n    if (!loadingUserSendMessage && dataUserSendMessage) {\n      setCurrentChat((prev) => ({\n        ...prev,\n        messages: getExtendMessages(dataUserSendMessage.sendTicketMessage, sender)\n      }))\n    }\n  }, [sender, dataUserSendMessage, loadingUserSendMessage])\n\n  useEffect(() => {\n    if (!loadingUserChats && userChats?.getUserChats) {\n      setChats((prev) => [...prev, ...userChats.getUserChats])\n    }\n  }, [userChats, loadingUserChats])\n\n  useEffect(() => {\n    if (!loadingUserTickets && userTickets?.getUserTickets) {\n      setChats((prev) => [...prev, ...userTickets.getUserTickets])\n    }\n  }, [userTickets, loadingUserTickets])\n\n  return (\n    <Wrap {...props} appearance={appearance}>\n      <Chats>\n        <ChatsSearch appearance={'ghost'} />\n        {loadingUserChats && !userChats && <Spinner />}\n        {chats.length > 0 ? (\n          chats.map((chat) => (\n            <Chat\n              key={chat.chat?.id || chat.id}\n              name={\n                chat.chat?.members.filter((member) => member.name !== sender.name)[0].name ||\n                chat.counsellor?.name\n              }\n              avatar={\n                chat.chat?.members.filter((member) => member.name !== sender.name)[0].avatar\n                  ?.path ||\n                chat.counsellor?.avatar?.path ||\n                '/images/avatar-default.png'\n              }\n              budge={\n                (chat.chat?.messages && getUnreadedMessages(chat.chat?.messages, sender)) ||\n                (chat.messages && getUnreadedMessages(chat.messages, sender)) ||\n                null\n              }\n              position={\n                (chat.chat?.messages && getLastMessage(chat.chat?.messages, sender)) ||\n                (chat.messages && getLastMessage(chat.messages, sender)) ||\n                null\n              }\n              onClick={async () => {\n                setLoading(true)\n                if (chat.chat?.id) {\n                  const variables = { id: chat.chat?.id }\n                  if (refetchChat) await refetchChat(variables)\n                  else await getChat({ variables, fetchPolicy })\n                  setCurrentChat(chat.chat)\n                } else {\n                  const variables = { id: chat.id }\n                  if (refetchTicket) await refetchTicket(variables)\n                  else await getTicket({ variables, fetchPolicy })\n                  setCurrentChat(chat)\n                }\n                setLoading(false)\n              }}\n              active={currentChat && currentChat.id === (chat.chat?.id || chat.id)}\n            />\n          ))\n        ) : loadingUserChats || loadingUserTickets ? (\n          <Loader>\n            <Spinner />\n          </Loader>\n        ) : (\n          <Alert style={{ marginTop: 15 }}>Активные чаты отсутствуют</Alert>\n        )}\n      </Chats>\n      <MessengerChat\n        chat={\n          currentChat && {\n            ...currentChat,\n            messages: currentChat.messages.map((message) => ({\n              ...message,\n              side: sender.name === message.user.name ? 'owner' : 'observer'\n            }))\n          }\n        }\n        appearance={'ghost'}\n        error={\n          errorChat ||\n          errorTicket ||\n          errorUserChats ||\n          errorUserTickets ||\n          errorSendMessage ||\n          errorUserSendMessage\n        }\n        loading={\n          loading ||\n          loadingTicket ||\n          loadingChat ||\n          loadingUserChats ||\n          loadingUserTickets ||\n          loadingSendMessage ||\n          loadingUserSendMessage\n        }\n        onLink={onMemberLink}\n        onAttach={onAttach}\n        onSubmit={(value) => {\n          if (currentChat.chat) {\n            sendMessage({\n              variables: {\n                recipient: currentChat.chat.recipient?.email,\n                text: value\n              },\n              fetchPolicy\n            })\n          } else {\n            sendTicketMessage({\n              variables: {\n                ticket: currentChat.id,\n                recipient: currentChat.author?.email,\n                text: value,\n                isClient: true\n              },\n              fetchPolicy\n            })\n          }\n        }}\n      />\n    </Wrap>\n  )\n}\n\nMessenger.defaultProps = {\n  appearance: 'default'\n}\n\nexport default Messenger\n"]},"metadata":{},"sourceType":"module"}