{"ast":null,"code":"function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } }\n\nfunction _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function _next(value) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, \"next\", value); } function _throw(err) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, \"throw\", err); } _next(undefined); }); }; }\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nfunction _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _unsupportedIterableToArray(arr, i) || _nonIterableRest(); }\n\nfunction _nonIterableRest() { throw new TypeError(\"Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\"); }\n\nfunction _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === \"string\") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === \"Object\" && o.constructor) n = o.constructor.name; if (n === \"Map\" || n === \"Set\") return Array.from(o); if (n === \"Arguments\" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }\n\nfunction _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }\n\nfunction _iterableToArrayLimit(arr, i) { if (typeof Symbol === \"undefined\" || !(Symbol.iterator in Object(arr))) return; var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i[\"return\"] != null) _i[\"return\"](); } finally { if (_d) throw _e; } } return _arr; }\n\nfunction _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\nimport React, { useState, useEffect, useMemo } from 'react';\nimport styled, { css } from 'styled-components';\nimport { useQuery, useMutation } from '@apollo/react-hooks';\nimport { useSelector, useDispatch } from 'react-redux';\nimport Row from '../../atomic-ui/components/Row';\nimport Column from '../../atomic-ui/components/Column';\nimport Member from '../../atomic-ui/components/Member';\nimport Alert from '../../atomic-ui/components/Alert';\nimport Search from '../../atomic-ui/components/Search';\nimport Spinner from '../../atomic-ui/components/Spinner';\nimport TicketChat from '../TicketChat';\nimport { setDocuments } from '../../store/actions/documents';\nimport queries from '../../graphql/queries';\nimport { Loader } from '../Styled';\nexport var Wrap = styled(Row).withConfig({\n  displayName: \"TicketView__Wrap\",\n  componentId: \"sc-1wxiq0b-0\"\n})([\"height:100%;flex-grow:1;@media only screen and (max-width:568px){flex-direction:column;}\", \" \", \" \", \"\"], function (_ref) {\n  var appearance = _ref.appearance;\n  return appearance === 'default' && css([\"padding:var(--default-gap);background:var(--surface-background);border:var(--surface-border);border-radius:var(--surface-border-radius);box-shadow:var(--surface-shadow);\"]);\n}, function (_ref2) {\n  var appearance = _ref2.appearance;\n  return appearance === 'ghost' && css([\"padding:0;border:none;background:none;border-radius:0;box-shadow:none;\"]);\n}, function (_ref3) {\n  var appearance = _ref3.appearance;\n  return appearance === 'clear' && css([\"padding:0;border:none;background:none;border-radius:0;box-shadow:none;\"]);\n});\nexport var Tickets = styled(Column).withConfig({\n  displayName: \"TicketView__Tickets\",\n  componentId: \"sc-1wxiq0b-1\"\n})([\"grid-gap:0;width:320px;@media only screen and (max-width:568px){width:100%;}\"]);\nexport var Ticket = styled(Member).withConfig({\n  displayName: \"TicketView__Ticket\",\n  componentId: \"sc-1wxiq0b-2\"\n})([\"margin:10px 0 0 0;padding:10px;border-radius:var(--surface-border-radius);\", \"\"], function (_ref4) {\n  var active = _ref4.active;\n  return active && css([\"background:var(--input-background);\"]);\n});\nexport var LIMIT_TICKETS = 36;\nexport var View = function View(_ref5) {\n  var auth = _ref5.auth,\n      ticket = _ref5.ticket,\n      appearance = _ref5.appearance,\n      onMemberLink = _ref5.onMemberLink,\n      onReport = _ref5.onReport,\n      onAttach = _ref5.onAttach,\n      props = _objectWithoutProperties(_ref5, [\"auth\", \"ticket\", \"appearance\", \"onMemberLink\", \"onReport\", \"onAttach\"]);\n\n  var _useState = useState(null),\n      _useState2 = _slicedToArray(_useState, 2),\n      currentTicket = _useState2[0],\n      setCurrentTicket = _useState2[1]; // TODO: Fetch more tickets by scrolling\n  // eslint-disable-next-line no-unused-vars\n\n\n  var _useState3 = useState(0),\n      _useState4 = _slicedToArray(_useState3, 2),\n      offsetTickets = _useState4[0],\n      setOffsetTickets = _useState4[1];\n\n  var _useState5 = useState(false),\n      _useState6 = _slicedToArray(_useState5, 2),\n      loadingTicket = _useState6[0],\n      setLoadingTicket = _useState6[1];\n\n  var _useState7 = useState([]),\n      _useState8 = _slicedToArray(_useState7, 2),\n      tickets = _useState8[0],\n      setTickets = _useState8[1];\n\n  var documents = useSelector(function (state) {\n    return state.documents;\n  });\n  var dispatch = useDispatch();\n  var variablesTickets = useMemo(function () {\n    return {\n      offset: offsetTickets,\n      limit: LIMIT_TICKETS\n    };\n  }, [offsetTickets]);\n\n  var _useQuery = useQuery(queries.GET_TICKET, {\n    variables: {\n      id: ticket\n    }\n  }),\n      data = _useQuery.data,\n      loading = _useQuery.loading,\n      refetch = _useQuery.refetch;\n\n  var _useMutation = useMutation(queries.CLOSE_TICKET),\n      _useMutation2 = _slicedToArray(_useMutation, 2),\n      closeTicket = _useMutation2[0],\n      _useMutation2$ = _useMutation2[1],\n      dataCloseTicket = _useMutation2$.data,\n      loadingCloseTicket = _useMutation2$.loading,\n      errorCloseTicket = _useMutation2$.error;\n\n  var _useMutation3 = useMutation(queries.SEND_TICKET_MESSAGE),\n      _useMutation4 = _slicedToArray(_useMutation3, 2),\n      sendTicketMessage = _useMutation4[0],\n      _useMutation4$ = _useMutation4[1],\n      dataSendMessage = _useMutation4$.data,\n      loadingSendMessage = _useMutation4$.loading;\n\n  var _useQuery2 = useQuery(queries.GET_TICKETS, {\n    variables: variablesTickets\n  }),\n      dataTickets = _useQuery2.data,\n      loadingTickets = _useQuery2.loading,\n      errorTickets = _useQuery2.error;\n\n  useEffect(function () {\n    if (!loading && data !== null && data !== void 0 && data.getTicket) {\n      setCurrentTicket(data.getTicket);\n    }\n\n    if (!loadingCloseTicket && dataCloseTicket !== null && dataCloseTicket !== void 0 && dataCloseTicket.closeTicket) {\n      var candidate = dataCloseTicket.closeTicket;\n      setCurrentTicket(candidate);\n      dispatch(setDocuments((documents || []).map(function (document) {\n        return document.id === candidate.id ? candidate : document;\n      })));\n    }\n  }, [data, dataCloseTicket, loading, loadingCloseTicket]);\n  useEffect(function () {\n    if (!loadingTickets && dataTickets) {\n      setTickets(dataTickets.getTickets);\n    }\n  }, [dataTickets, loadingTickets]);\n  useEffect(function () {\n    if (!loadingSendMessage && dataSendMessage) {\n      setCurrentTicket(function (prev) {\n        return _objectSpread(_objectSpread({}, prev), {}, {\n          messages: dataSendMessage.sendTicketMessage\n        });\n      });\n    }\n  }, [dataSendMessage, loadingSendMessage]);\n  return /*#__PURE__*/React.createElement(Wrap, _extends({}, props, {\n    appearance: appearance\n  }), /*#__PURE__*/React.createElement(Tickets, null, /*#__PURE__*/React.createElement(Search, {\n    appearance: 'ghost',\n    onSubmit: function onSubmit() {}\n  }), !loadingTickets ? tickets.map(function (item) {\n    var _item$author;\n\n    return /*#__PURE__*/React.createElement(Ticket, {\n      key: item.id,\n      name: item.title,\n      position: (_item$author = item.author) === null || _item$author === void 0 ? void 0 : _item$author.name,\n      active: currentTicket && currentTicket.id === item.id,\n      onClick: /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee() {\n        return regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                setLoadingTicket(true);\n                _context.next = 3;\n                return refetch({\n                  id: item.id\n                });\n\n              case 3:\n                setCurrentTicket(item);\n                setLoadingTicket(false);\n\n              case 5:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee);\n      }))\n    });\n  }) : errorTickets ? /*#__PURE__*/React.createElement(Alert, {\n    appearance: 'error',\n    style: {\n      marginTop: 15,\n      width: '100%',\n      textAlign: 'center'\n    }\n  }, \"\\u0423\\u043F\\u0441! \\u041D\\u0435 \\u0443\\u0434\\u0430\\u043B\\u043E\\u0441\\u044C \\u0437\\u0430\\u0433\\u0440\\u0443\\u0437\\u0438\\u0442\\u044C \\u0438\\u043D\\u0444\\u043E\\u0440\\u043C\\u0430\\u0446\\u0438\\u044E \\u043E\\u0431 \\u043E\\u0431\\u0440\\u0430\\u0449\\u0435\\u043D\\u0438\\u0438\") : /*#__PURE__*/React.createElement(Loader, null, /*#__PURE__*/React.createElement(Spinner, null))), /*#__PURE__*/React.createElement(TicketChat, {\n    auth: auth,\n    ticket: currentTicket,\n    loading: loading || loadingSendMessage || loadingTicket || loadingTickets || errorCloseTicket,\n    onLink: onMemberLink,\n    onFinish: function onFinish() {\n      return closeTicket({\n        variables: {\n          id: ticket\n        }\n      });\n    },\n    onReport: onReport,\n    onAttach: onAttach,\n    onSubmit: function onSubmit(value) {\n      var _currentTicket$author;\n\n      return sendTicketMessage({\n        variables: {\n          ticket: currentTicket.id,\n          recipient: (_currentTicket$author = currentTicket.author) === null || _currentTicket$author === void 0 ? void 0 : _currentTicket$author.email,\n          text: value\n        }\n      });\n    }\n  }));\n};\nView.defaultProps = {\n  appearance: 'default'\n};\nexport default View;","map":{"version":3,"sources":["C:/Users/dan82/Documents/workspace/FREELANCE/atomic/atomic-frontend/components/TicketView/index.js"],"names":["React","useState","useEffect","useMemo","styled","css","useQuery","useMutation","useSelector","useDispatch","Row","Column","Member","Alert","Search","Spinner","TicketChat","setDocuments","queries","Loader","Wrap","appearance","Tickets","Ticket","active","LIMIT_TICKETS","View","auth","ticket","onMemberLink","onReport","onAttach","props","currentTicket","setCurrentTicket","offsetTickets","setOffsetTickets","loadingTicket","setLoadingTicket","tickets","setTickets","documents","state","dispatch","variablesTickets","offset","limit","GET_TICKET","variables","id","data","loading","refetch","CLOSE_TICKET","closeTicket","dataCloseTicket","loadingCloseTicket","errorCloseTicket","error","SEND_TICKET_MESSAGE","sendTicketMessage","dataSendMessage","loadingSendMessage","GET_TICKETS","dataTickets","loadingTickets","errorTickets","getTicket","candidate","map","document","getTickets","prev","messages","item","title","author","name","marginTop","width","textAlign","value","recipient","email","text","defaultProps"],"mappings":"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","sourcesContent":["import React, { useState, useEffect, useMemo } from 'react'\nimport styled, { css } from 'styled-components'\nimport { useQuery, useMutation } from '@apollo/react-hooks'\nimport { useSelector, useDispatch } from 'react-redux'\n\nimport Row from '../../atomic-ui/components/Row'\nimport Column from '../../atomic-ui/components/Column'\nimport Member from '../../atomic-ui/components/Member'\nimport Alert from '../../atomic-ui/components/Alert'\nimport Search from '../../atomic-ui/components/Search'\nimport Spinner from '../../atomic-ui/components/Spinner'\n\nimport TicketChat from '../TicketChat'\nimport { setDocuments } from '../../store/actions/documents'\nimport queries from '../../graphql/queries'\nimport { Loader } from '../Styled'\n\nexport const Wrap = styled(Row)`\n  height: 100%;\n  flex-grow: 1;\n\n  @media only screen and (max-width: 568px) {\n    flex-direction: column;\n  }\n\n  ${({ appearance }) =>\n    appearance === 'default' &&\n    css`\n      padding: var(--default-gap);\n      background: var(--surface-background);\n      border: var(--surface-border);\n      border-radius: var(--surface-border-radius);\n      box-shadow: var(--surface-shadow);\n    `}\n\n  ${({ appearance }) =>\n    appearance === 'ghost' &&\n    css`\n      padding: 0;\n      border: none;\n      background: none;\n      border-radius: 0;\n      box-shadow: none;\n    `}\n\n  ${({ appearance }) =>\n    appearance === 'clear' &&\n    css`\n      padding: 0;\n      border: none;\n      background: none;\n      border-radius: 0;\n      box-shadow: none;\n    `}\n`\n\nexport const Tickets = styled(Column)`\n  grid-gap: 0;\n  width: 320px;\n\n  @media only screen and (max-width: 568px) {\n    width: 100%;\n  }\n`\n\nexport const Ticket = styled(Member)`\n  margin: 10px 0 0 0;\n  padding: 10px;\n  border-radius: var(--surface-border-radius);\n\n  ${({ active }) =>\n    active &&\n    css`\n      background: var(--input-background);\n    `}\n`\n\nexport const LIMIT_TICKETS = 36\n\nexport const View = ({ auth, ticket, appearance, onMemberLink, onReport, onAttach, ...props }) => {\n  const [currentTicket, setCurrentTicket] = useState(null)\n  // TODO: Fetch more tickets by scrolling\n  // eslint-disable-next-line no-unused-vars\n  const [offsetTickets, setOffsetTickets] = useState(0)\n  const [loadingTicket, setLoadingTicket] = useState(false)\n  const [tickets, setTickets] = useState([])\n  const documents = useSelector((state) => state.documents)\n  const dispatch = useDispatch()\n\n  const variablesTickets = useMemo(\n    () => ({\n      offset: offsetTickets,\n      limit: LIMIT_TICKETS\n    }),\n    [offsetTickets]\n  )\n\n  const { data, loading, refetch } = useQuery(queries.GET_TICKET, {\n    variables: {\n      id: ticket\n    }\n  })\n\n  const [\n    closeTicket,\n    { data: dataCloseTicket, loading: loadingCloseTicket, error: errorCloseTicket }\n  ] = useMutation(queries.CLOSE_TICKET)\n\n  const [sendTicketMessage, { data: dataSendMessage, loading: loadingSendMessage }] = useMutation(\n    queries.SEND_TICKET_MESSAGE\n  )\n\n  const {\n    data: dataTickets,\n    loading: loadingTickets,\n    error: errorTickets\n    // fetchMore: updateTickets\n  } = useQuery(queries.GET_TICKETS, {\n    variables: variablesTickets\n  })\n\n  useEffect(() => {\n    if (!loading && data?.getTicket) {\n      setCurrentTicket(data.getTicket)\n    }\n\n    if (!loadingCloseTicket && dataCloseTicket?.closeTicket) {\n      const candidate = dataCloseTicket.closeTicket\n\n      setCurrentTicket(candidate)\n      dispatch(\n        setDocuments(\n          (documents || []).map((document) => (document.id === candidate.id ? candidate : document))\n        )\n      )\n    }\n  }, [data, dataCloseTicket, loading, loadingCloseTicket])\n\n  useEffect(() => {\n    if (!loadingTickets && dataTickets) {\n      setTickets(dataTickets.getTickets)\n    }\n  }, [dataTickets, loadingTickets])\n\n  useEffect(() => {\n    if (!loadingSendMessage && dataSendMessage) {\n      setCurrentTicket((prev) => ({\n        ...prev,\n        messages: dataSendMessage.sendTicketMessage\n      }))\n    }\n  }, [dataSendMessage, loadingSendMessage])\n\n  return (\n    <Wrap {...props} appearance={appearance}>\n      <Tickets>\n        <Search appearance={'ghost'} onSubmit={() => {}} />\n        {!loadingTickets ? (\n          tickets.map((item) => (\n            <Ticket\n              key={item.id}\n              name={item.title}\n              position={item.author?.name}\n              active={currentTicket && currentTicket.id === item.id}\n              onClick={async () => {\n                setLoadingTicket(true)\n                await refetch({ id: item.id })\n                setCurrentTicket(item)\n                setLoadingTicket(false)\n              }}\n            />\n          ))\n        ) : errorTickets ? (\n          <Alert appearance={'error'} style={{ marginTop: 15, width: '100%', textAlign: 'center' }}>\n            Упс! Не удалось загрузить информацию об обращении\n          </Alert>\n        ) : (\n          <Loader>\n            <Spinner />\n          </Loader>\n        )}\n      </Tickets>\n      <TicketChat\n        auth={auth}\n        ticket={currentTicket}\n        loading={\n          loading || loadingSendMessage || loadingTicket || loadingTickets || errorCloseTicket\n        }\n        onLink={onMemberLink}\n        onFinish={() =>\n          closeTicket({\n            variables: {\n              id: ticket\n            }\n          })\n        }\n        onReport={onReport}\n        onAttach={onAttach}\n        onSubmit={(value) =>\n          sendTicketMessage({\n            variables: {\n              ticket: currentTicket.id,\n              recipient: currentTicket.author?.email,\n              text: value\n            }\n          })\n        }\n      />\n    </Wrap>\n  )\n}\n\nView.defaultProps = {\n  appearance: 'default'\n}\n\nexport default View\n"]},"metadata":{},"sourceType":"module"}