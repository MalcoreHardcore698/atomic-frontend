{"ast":null,"code":"import React, { useState, useEffect } from 'react';\nimport styled from 'styled-components';\nimport { Controller } from 'react-hook-form';\nimport { useQuery } from '@apollo/react-hooks';\nimport Row from '../../atomic-ui/components/Row';\nimport Column from '../../atomic-ui/components/Column';\nimport Input from '../../atomic-ui/components/Input';\nimport Button from '../../atomic-ui/components/Button';\nimport Title from '../../atomic-ui/components/Title';\nimport Alert from '../../atomic-ui/components/Alert';\nimport Select from '../../atomic-ui/components/Select';\nimport Divider from '../../atomic-ui/components/Divider';\nimport Spinner from '../../atomic-ui/components/Spinner';\nimport TextArea from '../../atomic-ui/components/TextArea';\nimport Checkbox from '../../atomic-ui/components/Checkbox';\nimport Message from '../../atomic-ui/components/Message';\nimport Form from '../Form';\nimport { Loader } from '../Styled';\nimport { getLabelCategory } from '../../utils/functions';\nimport queries from '../../graphql/queries';\nexport const LIMIT_USERS = 15;\nexport const Messages = styled(Column).withConfig({\n  displayName: \"FormTicket__Messages\",\n  componentId: \"n5aw2g-0\"\n})([\"grid-gap:5px;\"]);\nexport const Header = styled(Row).withConfig({\n  displayName: \"FormTicket__Header\",\n  componentId: \"n5aw2g-1\"\n})([\"justify-content:space-between;@media only screen and (max-width:480px){flex-direction:column;align-items:end;grid-gap:var(--default-gap);}\"]);\nexport const Ticket = ({\n  title,\n  ticket,\n  appearance,\n  mutation,\n  className,\n  isClient,\n  onSubmit\n}) => {\n  const [checkedAll, setCheckedAll] = useState(false); // const [offsetUsers, setOffsetUsers] = useState(0)\n  // const [usersSelectInput, setUsersSelectInput] = useState('')\n\n  const [messages, setMessages] = useState([]);\n  const [users, setUsers] = useState([]);\n  const {\n    data,\n    loading: loadingTicket,\n    error: errorTicket\n  } = ticket ? useQuery(queries.GET_TICKET, {\n    variables: {\n      id: ticket\n    },\n    fetchPolicy: 'no-cache'\n  }) : {\n    data: {\n      getTicket: {}\n    },\n    loading: false,\n    error: false\n  };\n  const {\n    data: dataUsers,\n    loading: loadingUsers // refetch: searchUsers,\n    // fetchMore: updateUsers\n\n  } = useQuery(queries.GET_USERS_FOR_TICKET, {\n    variables: {\n      // offset: offsetUsers,\n      account: ['INDIVIDUAL', 'OFICIAL']\n    }\n  });\n  const {\n    data: dataCounsellors,\n    loading: loadingCounsellors\n  } = useQuery(queries.GET_USERS_FOR_TICKET, {\n    variables: {\n      account: ['INDIVIDUAL', 'ADMIN']\n    }\n  });\n  const {\n    data: dataCategories,\n    loading: loadingCategories\n  } = useQuery(queries.GET_CATEGORIES, {\n    variables: {\n      type: 'TICKET'\n    }\n  });\n\n  const handleCheckedMessages = e => {\n    setCheckedAll(e.target.checked);\n  };\n\n  const handleCheckedMessage = (message, value) => {\n    setMessages(prev => prev.map(item => item.id === message.id ? { ...item,\n      checked: value\n    } : item));\n  };\n\n  const handleDeleteChecked = () => {\n    setMessages(prev => prev.filter(message => !message.checked));\n  };\n\n  const handleMessageEdit = (message, text) => {\n    setMessages(prev => prev.map(item => item.id === message.id ? { ...item,\n      updatedAt: new Date(),\n      text\n    } : item));\n  };\n\n  const handleMessageDelete = message => {\n    setMessages(prev => prev.filter(item => item.id !== message.id));\n  };\n\n  useEffect(() => {\n    if (ticket && !loadingTicket && data) {\n      setMessages(data.getTicket.messages.map(message => ({ ...message,\n        checked: false\n      })));\n    }\n  }, [ticket, data, loadingTicket]);\n  useEffect(() => {\n    if (!loadingUsers && dataUsers) {\n      setUsers(prev => [...prev, ...dataUsers.getUsers]);\n    }\n  }, [dataUsers, loadingUsers]);\n  return /*#__PURE__*/React.createElement(Form, {\n    className: className,\n    appearance: appearance,\n    mutation: mutation,\n    onSubmit: (form, action) => onSubmit({ ...form,\n      messages\n    }, action)\n  }, ({\n    register,\n    loading,\n    errors,\n    control,\n    getValues\n  }) => {\n    var _data$getTicket, _data$getTicket2, _data$getTicket2$mess, _data$getTicket3, _data$getTicket4, _data$getTicket5;\n\n    return !loadingTicket && data ? /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(Column, null, title && /*#__PURE__*/React.createElement(Title, {\n      tag: 'h4'\n    }, \"\\u041E\\u0441\\u043D\\u043E\\u0432\\u043D\\u043E\\u0435\"), errors && errors.title && /*#__PURE__*/React.createElement(Alert, {\n      style: {\n        width: '100%'\n      },\n      appearance: 'error'\n    }, \"\\u0412\\u0432\\u0435\\u0434\\u0438\\u0442\\u0435 \\u043D\\u0430\\u0437\\u0432\\u0430\\u043D\\u0438\\u0435 \\u043E\\u0431\\u0440\\u0430\\u0449\\u0435\\u043D\\u0438\\u0435\"), /*#__PURE__*/React.createElement(Input, {\n      type: 'text',\n      name: 'title',\n      ref: register({\n        required: true\n      }),\n      defaultValue: getValues('title') || ((_data$getTicket = data.getTicket) === null || _data$getTicket === void 0 ? void 0 : _data$getTicket.title),\n      placeholder: 'Краткое описание вашего вопроса',\n      appearance: 'ghost',\n      disabled: loading\n    }), (!ticket || ((_data$getTicket2 = data.getTicket) === null || _data$getTicket2 === void 0 ? void 0 : (_data$getTicket2$mess = _data$getTicket2.messages) === null || _data$getTicket2$mess === void 0 ? void 0 : _data$getTicket2$mess.length) === 0) && /*#__PURE__*/React.createElement(TextArea, {\n      type: 'text',\n      name: 'message',\n      ref: register(),\n      defaultValue: getValues('message') || '',\n      placeholder: 'Расскройте все подробности вашего вопроса',\n      disabled: loading,\n      appearance: 'ghost'\n    }), !isClient && /*#__PURE__*/React.createElement(Controller, {\n      name: 'author',\n      control: control,\n      defaultValue: (_data$getTicket3 = data.getTicket) !== null && _data$getTicket3 !== void 0 && _data$getTicket3.author ? {\n        value: data.getTicket.author.id,\n        label: data.getTicket.author.name\n      } : null,\n      render: ({\n        value,\n        onChange\n      }) => /*#__PURE__*/React.createElement(Select, {\n        options: users.map(user => ({\n          value: user,\n          label: user.name\n        })),\n        appearance: 'ghost',\n        defaultValue: value // inputValue={usersSelectInput}\n        ,\n        placeholder: 'Выберите автора обращения',\n        onChange: onChange // onInputChange={(input) => setUsersSelectInput(input)}\n        // onKeyDown={(e) => {\n        //   // Pressed ENTER\n        //   if (e.keyCode === 13) {\n        //     searchUsers({\n        //       search: usersSelectInput\n        //     })\n        //   }\n        // }}\n        // onMenuScrollToBottom={async () => {\n        //   await updateUsers({\n        //     variables: {\n        //       offset: offsetUsers,\n        //       limit: LIMIT_USERS\n        //     },\n        //     updateQuery: (...props) => props\n        //   })\n        //   setOffsetUsers((prev) => prev + LIMIT_USERS)\n        // }}\n        ,\n        isLoading: loadingUsers,\n        isSearchable: true\n      })\n    }), !isClient && /*#__PURE__*/React.createElement(Controller, {\n      name: 'counsellor',\n      control: control,\n      defaultValue: (_data$getTicket4 = data.getTicket) !== null && _data$getTicket4 !== void 0 && _data$getTicket4.counsellor ? {\n        value: data.getTicket.counsellor.id,\n        label: data.getTicket.counsellor.name\n      } : null,\n      render: ({\n        value,\n        onChange\n      }) => /*#__PURE__*/React.createElement(Select, {\n        options: !loadingCounsellors && dataCounsellors ? dataCounsellors.getUsers.map(user => ({\n          value: user,\n          label: user.name\n        })) : [],\n        appearance: 'ghost',\n        defaultValue: value,\n        placeholder: 'Выберите советника',\n        onChange: onChange,\n        isLoading: loadingCounsellors,\n        isSearchable: true\n      })\n    }), /*#__PURE__*/React.createElement(Controller, {\n      name: 'category',\n      control: control,\n      defaultValue: (_data$getTicket5 = data.getTicket) !== null && _data$getTicket5 !== void 0 && _data$getTicket5.category ? {\n        value: data.getTicket.category.id,\n        label: getLabelCategory(data.getTicket.category.name)\n      } : null,\n      render: ({\n        value,\n        onChange\n      }) => /*#__PURE__*/React.createElement(Select, {\n        appearance: 'ghost',\n        placeholder: 'Выберите раздел',\n        options: !loadingCategories && dataCategories ? dataCategories.getCategories.filter(item => item.type === 'TICKET').map(item => ({\n          value: item.id,\n          label: getLabelCategory(item.name)\n        })) : [],\n        onChange: onChange,\n        defaultValue: value,\n        isLoading: loadingCategories,\n        isClearable: true\n      })\n    })), !isClient && ticket && messages.length > 0 && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(Divider, {\n      clear: true\n    }), /*#__PURE__*/React.createElement(Title, {\n      tag: 'h4'\n    }, \"\\u0418\\u0441\\u0442\\u043E\\u0440\\u0438\\u044F \\u0441\\u043E\\u043E\\u0431\\u0449\\u0435\\u043D\\u0438\\u0439\"), /*#__PURE__*/React.createElement(Header, null, /*#__PURE__*/React.createElement(Checkbox, {\n      label: 'Выделить все',\n      checked: checkedAll,\n      onChange: handleCheckedMessages\n    }), /*#__PURE__*/React.createElement(Button, {\n      style: {\n        color: 'var(--default-color-red)'\n      },\n      appearance: 'clear',\n      onClick: handleDeleteChecked\n    }, \"\\u0423\\u0434\\u0430\\u043B\\u0438\\u0442\\u044C \\u0432\\u044B\\u0434\\u0435\\u043B\\u0435\\u043D\\u043D\\u043E\\u0435\")), /*#__PURE__*/React.createElement(Messages, null, messages.map(message => {\n      var _message$user, _message$user$avatar, _message$user2;\n\n      return /*#__PURE__*/React.createElement(Message, {\n        key: message.id,\n        avatar: (_message$user = message.user) === null || _message$user === void 0 ? void 0 : (_message$user$avatar = _message$user.avatar) === null || _message$user$avatar === void 0 ? void 0 : _message$user$avatar.path,\n        name: (_message$user2 = message.user) === null || _message$user2 === void 0 ? void 0 : _message$user2.name,\n        text: message.text,\n        time: message.createdAt !== message.updatedAt ? message.updatedAt : message.createdAt,\n        isChecked: message.checked,\n        isUpdated: message.createdAt !== message.updatedAt,\n        onChecked: value => handleCheckedMessage(message, value),\n        onEdit: text => handleMessageEdit(message, text),\n        onDelete: () => handleMessageDelete(message),\n        compact: true\n      });\n    }))), /*#__PURE__*/React.createElement(Divider, {\n      clear: true\n    }), /*#__PURE__*/React.createElement(Row, null, /*#__PURE__*/React.createElement(Button, {\n      style: {\n        flexGrow: 1\n      },\n      type: 'submit',\n      disabled: loading\n    }, ticket ? 'Сохранить' : 'Создать'))) : errorTicket ? /*#__PURE__*/React.createElement(Alert, {\n      appearance: 'error',\n      style: {\n        width: '100%',\n        textAlign: 'center'\n      }\n    }, \"\\u0423\\u043F\\u0441! \\u041D\\u0435 \\u0443\\u0434\\u0430\\u043B\\u043E\\u0441\\u044C \\u0437\\u0430\\u0433\\u0440\\u0443\\u0437\\u0438\\u0442\\u044C \\u0438\\u043D\\u0444\\u043E\\u0440\\u043C\\u0430\\u0446\\u0438\\u044E \\u043E\\u0431 \\u043E\\u0431\\u0440\\u0430\\u0449\\u0435\\u043D\\u0438\\u0438\") : /*#__PURE__*/React.createElement(Loader, null, /*#__PURE__*/React.createElement(Spinner, null));\n  });\n};\nTicket.defaultProps = {\n  title: true\n};\nexport default Ticket;","map":null,"metadata":{},"sourceType":"module"}